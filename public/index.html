<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shifter</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        ios: { bg: '#F2F2F7', card: '#FFFFFF', blue: '#007AFF', green: '#34C759', input: '#E5E5EA' },
                        darkios: { bg: '#000000', card: '#1C1C1E', input: '#2C2C2E' }
                    },
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .glass-header { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass-header { background: rgba(28, 28, 30, 0.85); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .ios-card { background: white; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .dark .ios-card { background: #1C1C1E; box-shadow: none; }
        
        /* TIMELINE STYLES */
        .timeline-track { position: relative; height: 24px; background: #F3F4F6; border-radius: 8px; overflow: hidden; width: 100%; margin-top: 4px; }
        .dark .timeline-track { background: #2C2C2E; }
        .timeline-grid-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: grid; grid-template-columns: repeat(10, 1fr); pointer-events: none; }
        .timeline-line { border-right: 1px dashed rgba(0,0,0,0.05); height: 100%; }
        .dark .timeline-line { border-color: rgba(255,255,255,0.05); }
        .timeline-line:last-child { border: none; }

        /* COLORS UPDATED: Others - Blue, Me - Green */
        .shift-segment { position: absolute; top: 0; bottom: 0; background: #007AFF; border-radius: 6px; z-index: 10; opacity: 0.9; }
        .shift-segment.my-shift { background: #34C759; }
        
        .task-segment { position: absolute; top: 2px; bottom: 2px; background: #AF52DE; border-radius: 4px; z-index: 20; box-shadow: 0 1px 3px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 9px; font-weight: bold; display: flex; align-items: center; justify-content: center; overflow: hidden; white-space: nowrap; }
        
        .ios-input { background: #E5E5EA; border: none; border-radius: 12px; padding: 10px 14px; width: 100%; font-size: 15px; outline: none; }
        .dark .ios-input { background: #2C2C2E; color: white; }
        .btn-primary { background: #007AFF; color: white; border-radius: 12px; font-weight: 600; padding: 12px; width: 100%; }
        
        /* CALENDAR STYLES (UPDATED FOR CONTRAST) */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        
        .calendar-day { 
            min-height: 80px; 
            border-radius: 12px; 
            padding: 6px; 
            font-size: 12px; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            transition: all 0.2s;
            /* Light Mode Default */
            background: #FFFFFF;
            border: 1px solid transparent;
            color: #1c1c1e;
        }

        /* Dark Mode Default (Empty Day) - Dark Gray Card to stand out from Black bg */
        .dark .calendar-day { 
            background: #1C1C1E; 
            color: #8E8E93; /* Dimmed text for empty days */
        }
        
        /* TODAY Highlight */
        .calendar-day.today { 
            border: 2px solid #007AFF; 
        }

        /* WORK DAY (MY SHIFT) - GREEN THEME */
        /* Light Mode */
        .calendar-day.my-work-day {
            background: #F0FDF4; /* Very light green */
            border: 1px solid #BBF7D0;
            color: #14532D;
        }
        
        /* Dark Mode - The "Neon" Fix */
        .dark .calendar-day.my-work-day {
            background: rgba(52, 199, 89, 0.20) !important; /* Semi-transparent Green */
            border: 1px solid rgba(52, 199, 89, 0.5); /* Subtle Green Border */
            color: #FFFFFF; /* Bright text */
        }

        .work-badge {
            font-size: 10px;
            font-weight: 700;
            margin-top: auto;
            color: #34C759; /* Green text in calendar */
        }
        .dark .work-badge {
            color: #4ADE80; /* Brighter green for dark mode */
        }
        
        /* Modal Animation */
        .modal-enter { transform: translateY(100%); opacity: 0; }
        .modal-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-exit { transform: translateY(0); opacity: 1; }
        .modal-exit-active { transform: translateY(100%); opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        ::-webkit-scrollbar { width: 0; }
    </style>
</head>
<body class="bg-[#F2F2F7] text-black dark:bg-black dark:text-white font-sans min-h-screen flex flex-col">

    <div id="loginScreen" class="flex-grow flex items-center justify-center p-6">
        <div class="ios-card p-8 w-full max-w-sm text-center">
            <h1 class="text-3xl font-bold mb-2 tracking-tight">Shifter</h1>
            <p class="text-gray-400 mb-8 text-sm">–£–≤—ñ–π–¥—ñ—Ç—å –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –≥—Ä–∞—Ñ—ñ–∫—É</p>
            <div id="tgLoader" class="hidden mb-4 text-blue-500 font-medium animate-pulse">üîÑ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è...</div>
            <div id="loginForm" class="space-y-3">
                <input type="text" id="loginUser" placeholder="–õ–æ–≥—ñ–Ω" class="ios-input">
                <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å" class="ios-input">
                <button onclick="login()" class="btn-primary mt-4">–£–≤—ñ–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <div id="appScreen" class="hidden w-full pb-24 relative">
        <nav class="glass-header px-4 py-3 sticky top-0 z-40 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gray-100 dark:bg-[#2C2C2E] rounded-full flex items-center justify-center text-lg">üë§</div>
                <div><h1 id="userNameDisplay" class="font-bold text-lg leading-tight">...</h1></div>
            </div>
            <div class="flex items-center gap-2">
                <button id="toggleEditBtn" onclick="toggleEditMode()" class="hidden bg-gray-200 dark:bg-[#3A3A3C] px-3 py-1.5 rounded-full text-xs font-bold">–ú–µ–Ω—é</button>
                <button onclick="logout()" class="text-blue-500 text-sm font-medium">–í–∏–π—Ç–∏</button>
            </div>
        </nav>

        <div class="container mx-auto p-4 max-w-lg space-y-4">
            
            <div class="flex justify-between items-center ios-card p-1.5">
                <div class="flex bg-[#E5E5EA] dark:bg-[#2C2C2E] rounded-[10px] p-0.5 w-full">
                    <button onclick="setMode('list')" id="btnModeList" class="flex-1 py-1.5 text-xs font-semibold rounded-[8px] bg-white dark:bg-[#636366] shadow-sm text-black dark:text-white">–°–ø–∏—Å–æ–∫</button>
                    <button onclick="setMode('calendar')" id="btnModeCalendar" class="flex-1 py-1.5 text-xs font-medium text-gray-500">–ö–∞–ª–µ–Ω–¥–∞—Ä</button>
                </div>
                <div class="flex items-center gap-3 ml-3 pr-1">
                    <button onclick="downloadAllMyShifts()" class="text-blue-500 text-xl">üì•</button>
                    <button onclick="toggleTheme()" class="text-gray-400 text-xl"><span id="themeIcon">üåô</span></button>
                </div>
            </div>

            <button onclick="openFilterModal()" class="ios-card w-full px-4 py-3 flex justify-between items-center active:scale-[0.98] transition-transform">
                <span class="text-sm font-semibold text-gray-500">–§—ñ–ª—å—Ç—Ä</span>
                <div class="flex items-center gap-2">
                    <span id="currentFilterLabel" class="text-blue-500 font-medium text-sm">–í—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</span>
                    <span class="text-gray-300 text-xs">‚ñº</span>
                </div>
            </button>

            <div id="adminPanel" class="hidden ios-card p-5 border border-orange-100 dark:border-orange-900/30">
                <h2 class="text-xl font-bold mb-4">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h2>
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">
                    <button onclick="showAdminTab('shifts')" class="bg-[#F2F2F7] dark:bg-[#2C2C2E] px-4 py-2 rounded-full text-xs font-bold">–ì—Ä–∞—Ñ—ñ–∫</button>
                    <button onclick="showAdminTab('tasks')" class="bg-[#F2F2F7] dark:bg-[#2C2C2E] px-4 py-2 rounded-full text-xs font-bold">–ó–∞–¥–∞—á—ñ</button>
                    <button onclick="showAdminTab('requests')" class="hidden bg-red-100 text-red-600 px-4 py-2 rounded-full text-xs font-bold" id="tabRequestsBtn">–ó–∞–ø–∏—Ç–∏</button>
                </div>

                <div id="adminTabShifts" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3"><input type="date" id="shiftDate" class="ios-input"><select id="employeeSelect" class="ios-input bg-transparent"><option disabled selected>–•—Ç–æ?</option></select></div>
                    <div class="flex gap-3"><input type="time" id="startTime" class="ios-input" value="10:00"><input type="time" id="endTime" class="ios-input" value="20:00"></div>
                    <button onclick="addShift()" class="btn-primary">–î–æ–¥–∞—Ç–∏ –∑–º—ñ–Ω—É</button>
                    <button onclick="clearDay()" class="text-xs text-red-500 w-full mt-2">–û—á–∏—Å—Ç–∏—Ç–∏ –¥–µ–Ω—å</button>
                </div>

                <div id="adminTabTasks" class="hidden space-y-3">
                    <input type="text" id="taskTitle" placeholder="–ù–∞–∑–≤–∞ (–Ω–∞–ø—Ä. –¢—Ä–µ–Ω—ñ–Ω–≥)" class="ios-input">
                    <div class="grid grid-cols-2 gap-3"><input type="date" id="taskDate" class="ios-input"><select id="taskEmployee" class="ios-input bg-transparent"><option disabled selected>–ö–æ–º—É?</option></select></div>
                    <div class="flex items-center justify-between"><span class="text-sm">–í–µ—Å—å –¥–µ–Ω—å</span><input type="checkbox" id="taskFullDay" onchange="toggleTaskTimeInputs()" class="w-5 h-5 accent-purple-500"></div>
                    <div id="taskTimeInputs" class="flex gap-3"><input type="time" id="taskStart" class="ios-input" value="12:00"><input type="time" id="taskEnd" class="ios-input" value="14:00"></div>
                    <button onclick="addTask()" class="btn-primary bg-purple-500">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏</button>
                </div>
                
                <div id="adminTabRequests" class="hidden space-y-3"><button onclick="approveAllRequests()" class="btn-primary bg-green-500">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –í—Å—ñ</button><div id="requestsList" class="space-y-3"></div></div>
            </div>

            <div id="listViewContainer">
                <button id="archiveToggleBtn" onclick="toggleArchive()" class="hidden w-full text-center text-xs text-gray-400 py-3 mb-2 font-medium">‚Üì –ü–æ–∫–∞–∑–∞—Ç–∏ –º–∏–Ω—É–ª—ñ –¥–Ω—ñ (<span id="archiveCount">0</span>) ‚Üì</button>
                <div id="archiveContainer" class="hidden space-y-3 mb-3 opacity-60 grayscale"></div>
                <div id="scheduleView" class="space-y-3"></div>
            </div>

            <div id="calendarViewContainer" class="hidden ios-card p-4">
                <div class="flex justify-between items-center mb-4"><button onclick="changeMonth(-1)" class="text-blue-500 text-xl font-bold">‚Äπ</button><h2 id="calendarTitle" class="font-bold text-xl capitalize"></h2><button onclick="changeMonth(1)" class="text-blue-500 text-xl font-bold">‚Ä∫</button></div>
                <div class="grid grid-cols-7 gap-1 text-center text-[10px] text-gray-400 uppercase mb-2"><div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div class="text-red-400">–ù–¥</div></div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>
        </div>

        <div id="filterModal" class="hidden fixed inset-0 z-50">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeFilterModal()"></div>
            <div class="absolute bottom-0 left-0 right-0 bg-white dark:bg-[#1C1C1E] rounded-t-[20px] max-h-[70vh] overflow-y-auto p-4 modal-enter-active">
                <div class="flex justify-between items-center mb-4 px-2">
                    <h3 class="font-bold text-lg">–û–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</h3>
                    <button onclick="closeFilterModal()" class="w-8 h-8 bg-gray-100 dark:bg-[#2C2C2E] rounded-full text-gray-500 text-sm font-bold">‚úï</button>
                </div>
                <div id="filterList" class="space-y-1">
                    </div>
            </div>
        </div>

    </div>

    <script>
        const tg = window.Telegram.WebApp;
        if (tg.platform && tg.platform !== 'unknown') { try { tg.expand(); } catch(e){} }

        let currentUser = null; let globalShifts = []; let globalUsers = []; let globalTasks = [];
        let activeFilter = 'all'; 
        
        const START_HOUR = 10; const TOTAL_HOURS = 10;
        let currentCalendarDate = new Date();

        function initTheme() {
            if ((tg.platform !== 'unknown' && tg.colorScheme === 'dark') || localStorage.theme === 'dark') { 
                document.documentElement.classList.add('dark'); document.getElementById('themeIcon').innerText = '‚òÄÔ∏è'; 
                if(tg.platform!=='unknown'){tg.setHeaderColor('#1C1C1E'); tg.setBackgroundColor('#000000');}
            } else { 
                document.documentElement.classList.remove('dark'); document.getElementById('themeIcon').innerText = 'üåô'; 
                if(tg.platform!=='unknown'){tg.setHeaderColor('#FFFFFF'); tg.setBackgroundColor('#F2F2F7');}
            }
        }
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) { html.classList.remove('dark'); localStorage.theme = 'light'; document.getElementById('themeIcon').innerText = 'üåô'; if(tg.platform!=='unknown'){tg.setHeaderColor('#FFFFFF'); tg.setBackgroundColor('#F2F2F7');} } 
            else { html.classList.add('dark'); localStorage.theme = 'dark'; document.getElementById('themeIcon').innerText = '‚òÄÔ∏è'; if(tg.platform!=='unknown'){tg.setHeaderColor('#1C1C1E'); tg.setBackgroundColor('#000000');} }
        }
        initTheme();

        // --- AUTH ---
        async function checkAuth() { 
            try { 
                const res = await fetch('/api/me'); const data = await res.json(); 
                if (data.loggedIn) { showApp(data.user); return; } 
            } catch (e) {}
            
            if (tg.platform && tg.platform !== 'unknown' && tg.initDataUnsafe?.user?.id) {
                document.getElementById('loginForm').classList.add('hidden'); document.getElementById('tgLoader').classList.remove('hidden');
                try {
                    const res = await fetch('/api/login-telegram', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telegramId: tg.initDataUnsafe.user.id }) });
                    const data = await res.json();
                    if (data.success) showApp(data.user); else { document.getElementById('tgLoader').classList.add('hidden'); document.getElementById('loginForm').classList.remove('hidden'); }
                } catch (e) { document.getElementById('tgLoader').classList.add('hidden'); document.getElementById('loginForm').classList.remove('hidden'); }
            } else { showLogin(); }
        }
        async function login() {
            const username = document.getElementById('loginUser').value; const password = document.getElementById('loginPass').value;
            try { const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) }); const data = await res.json();
                if (data.success) showApp(data.user); else alert(data.message);
            } catch (e) { alert("Error"); }
        }
        async function logout() { await fetch('/api/logout', { method: 'POST' }); window.location.reload(); }
        function showLogin() { currentUser = null; document.getElementById('appScreen').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); }

        async function showApp(user) {
            currentUser = user; 
            document.getElementById('loginScreen').classList.add('hidden'); 
            document.getElementById('appScreen').classList.remove('hidden');
            const parts = user.name.split(' '); document.getElementById('userNameDisplay').innerText = `–ü—Ä–∏–≤—ñ—Ç, ${parts.length > 1 ? parts[1] : parts[0]}`; 
            
            if (['admin', 'SM', 'SSE', 'RRP'].includes(user.role)) {
                if(user.role !== 'RRP') document.getElementById('toggleEditBtn').classList.remove('hidden');
                if (['SM', 'admin'].includes(user.role)) { 
                    document.getElementById('tabRequestsBtn').classList.remove('hidden'); 
                    loadRequests(); 
                }
            }
            
            await Promise.all([loadEmployeeList(), loadShifts(), loadTasks()]);
            renderCurrentShifts();
        }

        // --- FILTER ---
        function openFilterModal() {
            const modal = document.getElementById('filterModal');
            const list = document.getElementById('filterList');
            modal.classList.remove('hidden');
            let html = `<button onclick="applyFilter('all')" class="w-full text-left p-3 rounded-xl flex justify-between items-center ${activeFilter==='all' ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-500' : 'hover:bg-gray-50 dark:hover:bg-[#2C2C2E]'}"><span class="font-medium">–í—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</span>${activeFilter==='all' ? '<span>‚úì</span>' : ''}</button>`;
            globalUsers.forEach(u => { const isSelected = activeFilter === u.name; html += `<button onclick="applyFilter('${u.name}')" class="w-full text-left p-3 rounded-xl flex justify-between items-center ${isSelected ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-500' : 'hover:bg-gray-50 dark:hover:bg-[#2C2C2E]'}"><span class="font-medium">${u.name}</span>${isSelected ? '<span>‚úì</span>' : ''}</button>`; });
            list.innerHTML = html;
        }
        function closeFilterModal() { document.getElementById('filterModal').classList.add('hidden'); }
        function applyFilter(val) { activeFilter = val; document.getElementById('currentFilterLabel').innerText = val === 'all' ? '–í—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏' : val.split(' ')[1] || val; closeFilterModal(); renderCurrentShifts(); }

        // --- LOADERS ---
        async function loadEmployeeList() { 
            const res = await fetch('/api/users'); 
            if(res.ok){
                const d=await res.json(); 
                const workers = d.filter(u => u.role !== 'admin' && u.role !== 'RRP'); 
                globalUsers = workers; 
                const s1=document.getElementById('employeeSelect'); s1.innerHTML='<option disabled selected>–•—Ç–æ?</option>'; 
                const s2=document.getElementById('taskEmployee'); s2.innerHTML='<option disabled selected>–ö–æ–º—É?</option>'; 
                workers.forEach(x=>{ s1.innerHTML+=`<option value="${x.name}">${x.name}</option>`; s2.innerHTML+=`<option value="${x.name}">${x.name}</option>`; });
            }
        }
        async function loadShifts() { const r = await fetch('/api/shifts'); if(r.ok) globalShifts = await r.json(); }
        async function loadTasks() { const r = await fetch('/api/tasks'); if(r.ok) globalTasks = await r.json(); }
        async function loadRequests(){ const r=await fetch('/api/requests'); const d=await r.json(); const c=document.getElementById('requestsList'); c.innerHTML=''; if(d.length===0){c.innerHTML='<p class="text-gray-400 text-xs text-center">–ü—É—Å—Ç–æ</p>';return;} d.forEach(q=>{c.innerHTML+=`<div class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-xs flex justify-between"><span>${q.type}: ${q.createdBy}</span><div class="flex gap-2"><button onclick="handleRequest('${q._id}','approve')" class="text-green-600">‚úÖ</button><button onclick="handleRequest('${q._id}','reject')" class="text-red-600">‚ùå</button></div></div>`}); }

        // --- RENDER TIMELINE ---
        function renderTimeline(shifts, filterUser) {
            const main = document.getElementById('scheduleView'); main.innerHTML = '';
            const archive = document.getElementById('archiveContainer'); archive.innerHTML = '';
            
            const dates = [...new Set(shifts.map(s => s.date))].sort();
            const today = new Date().toISOString().split('T')[0];
            if (!dates.includes(today)) dates.push(today);
            dates.sort();

            let pastDaysCount = 0;
            let usersToShow = (activeFilter === 'all') ? globalUsers : globalUsers.filter(u => u.name === activeFilter);

            dates.forEach(dateStr => {
                const isPast = dateStr < today;
                const isToday = dateStr === today;
                const dObj = new Date(dateStr);
                const dName = dObj.toLocaleDateString('uk-UA', { weekday: 'long', day: 'numeric', month: 'long' });

                const block = document.createElement('div');
                block.className = 'ios-card p-4';
                if(isToday) block.classList.add('ring-2', 'ring-blue-500');

                let html = `<div class="mb-3 border-b border-gray-100 dark:border-gray-800 pb-2"><h3 class="font-bold text-lg capitalize ${isToday?'text-blue-500':'text-black dark:text-white'}">${dName}</h3></div><div class="space-y-4">`;

                usersToShow.forEach(user => {
                    const shift = shifts.find(s => s.date === dateStr && s.name === user.name);
                    const userTasks = globalTasks.filter(t => t.date === dateStr && t.name === user.name);
                    const parts = user.name.split(' '); 
                    const shortName = parts.length > 1 ? parts[1] : parts[0];

                    if (shift) {
                        const isMe = shift.name === currentUser.name;
                        const [sH, sM] = shift.start.split(':').map(Number);
                        const [eH, eM] = shift.end.split(':').map(Number);
                        const startDecimal = sH + sM/60; 
                        const endDecimal = eH + eM/60;   
                        let left = ((startDecimal - START_HOUR) / TOTAL_HOURS) * 100;
                        let width = ((endDecimal - startDecimal) / TOTAL_HOURS) * 100;
                        if(left < 0) { width += left; left = 0; } 
                        if(left + width > 100) width = 100 - left;

                        let tasksHtml = '';
                        let badges = '';
                        userTasks.forEach(task => {
                            if(task.isFullDay) {
                                badges += `<span class="ml-2 text-[10px] text-purple-600 font-bold border border-purple-200 px-1 rounded">‚òÖ ${task.title}</span>`;
                            } else {
                                const [tS_h, tS_m] = task.start.split(':').map(Number);
                                const [tE_h, tE_m] = task.end.split(':').map(Number);
                                const tStartD = tS_h + tS_m/60;
                                const tEndD = tE_h + tE_m/60;
                                let tLeft = ((tStartD - START_HOUR) / TOTAL_HOURS) * 100;
                                let tWidth = ((tEndD - tStartD) / TOTAL_HOURS) * 100;
                                const delTask = (['admin','SM','SSE'].includes(currentUser.role) && currentUser.role !== 'RRP') ? `onclick="deleteTask('${task._id}')"` : '';
                                tasksHtml += `<div class="task-segment" ${delTask} style="left:${tLeft}%; width:${tWidth}%;">${task.title}</div>`;
                            }
                        });

                        const delShift = (['admin','SM','SSE'].includes(currentUser.role) && currentUser.role !== 'RRP') ? `<button onclick="delS('${shift.date}','${shift.name}')" class="ml-auto text-gray-300 hover:text-red-500">‚úï</button>` : '';

                        html += `
                        <div>
                            <div class="flex items-center text-xs mb-1 font-medium ${isMe?'text-blue-500':'text-gray-900 dark:text-gray-200'}">
                                <span>${shortName}</span> <span class="ml-2 text-gray-400 font-mono">${shift.start}-${shift.end}</span> ${badges} ${delShift}
                            </div>
                            <div class="timeline-track">
                                <div class="timeline-grid-overlay">${Array(10).fill('<div class="timeline-line"></div>').join('')}</div>
                                <div class="shift-segment ${isMe?'my-shift':''}" style="left:${left}%; width:${width}%"></div>
                                ${tasksHtml}
                            </div>
                        </div>`;
                    } else if (userTasks.length > 0) {
                        let tasksHtml = '';
                        userTasks.forEach(task => {
                            if(!task.isFullDay) {
                                const [tS_h, tS_m] = task.start.split(':').map(Number);
                                const [tE_h, tE_m] = task.end.split(':').map(Number);
                                const tStartD = tS_h + tS_m/60;
                                const tEndD = tE_h + tE_m/60;
                                let tLeft = ((tStartD - START_HOUR) / TOTAL_HOURS) * 100;
                                let tWidth = ((tEndD - tStartD) / TOTAL_HOURS) * 100;
                                tasksHtml += `<div class="task-segment" style="left:${tLeft}%; width:${tWidth}%; background:#FF9500;">${task.title}</div>`;
                            }
                        });
                        html += `
                        <div class="opacity-80">
                            <div class="flex items-center text-xs mb-1 text-gray-500"><span>${shortName}</span> <span class="ml-2 text-orange-500 font-bold">–¢—ñ–ª—å–∫–∏ –∑–∞–¥–∞—á–∞</span></div>
                            <div class="timeline-track"><div class="timeline-grid-overlay">${Array(10).fill('<div class="timeline-line"></div>').join('')}</div>${tasksHtml}</div>
                        </div>`;
                    } else {
                        html += `
                        <div class="opacity-50">
                            <div class="flex items-center justify-between text-xs mb-1 text-gray-400"><span>${shortName}</span> <span>–í–∏—Ö—ñ–¥–Ω–∏–π</span></div>
                            <div class="h-[1px] bg-gray-100 dark:bg-gray-800 rounded w-full mt-3 mb-4"></div>
                        </div>`;
                    }
                });

                html += `</div>`;
                block.innerHTML = html;
                if(isPast) { archive.appendChild(block); pastDaysCount++; } else { main.appendChild(block); }
                if(isToday) setTimeout(()=>block.scrollIntoView({behavior:'smooth',block:'center'}),500);
            });

            const arcBtn = document.getElementById('archiveToggleBtn');
            const arcCnt = document.getElementById('archiveCount');
            if(pastDaysCount > 0) { arcBtn.classList.remove('hidden'); arcCnt.innerText = pastDaysCount; } else { arcBtn.classList.add('hidden'); }
        }

        // --- CALENDAR RENDER (FIXED) ---
        function renderCalendar() {
            const g = document.getElementById('calendarGrid'); g.innerHTML=''; const t=document.getElementById('calendarTitle');
            const y=currentCalendarDate.getFullYear(); const m=currentCalendarDate.getMonth();
            t.innerText = new Date(y, m).toLocaleDateString('uk-UA', { month: 'long', year: 'numeric' });
            
            const fd=new Date(y,m,1).getDay() || 7; 
            const ld=new Date(y,m+1,0).getDate();
            
            for(let i=1; i<fd; i++) g.innerHTML+=`<div class="calendar-day opacity-0"></div>`;
            
            const today = new Date().toISOString().split('T')[0];
            for(let d=1; d<=ld; d++){
                const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const shift = globalShifts.find(s=>s.date===ds && s.name===currentUser.name);
                const tasks = globalTasks.filter(t=>t.date===ds && t.name===currentUser.name);
                
                let content = `<div class="font-bold mb-1">${d}</div>`;
                if(shift) content += `<div class="work-badge">${shift.start}-${shift.end}</div>`;
                tasks.forEach(task => content += `<div class="text-[9px] text-purple-500 truncate">‚òÖ ${task.title}</div>`);
                
                // ADDED CLASS 'my-work-day' IF SHIFT EXISTS
                const workClass = shift ? 'my-work-day' : '';
                const todayClass = ds === today ? 'today' : '';
                
                g.innerHTML += `<div class="calendar-day ${todayClass} ${workClass}">${content}</div>`;
            }
        }

        // --- ACTIONS ---
        async function handleRequest(id, a){await fetch('/api/requests/action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,action:a})});loadRequests();loadShifts();loadTasks();setTimeout(()=>renderCurrentShifts(),500);}
        async function approveAllRequests(){if(!confirm("–í—Å–µ?"))return;await fetch('/api/requests/approve-all',{method:'POST'});loadRequests();loadShifts();loadTasks();setTimeout(()=>renderCurrentShifts(),500);}
        async function addShift() { 
            const date=document.getElementById('shiftDate').value; const name=document.getElementById('employeeSelect').value; const start=document.getElementById('startTime').value; const end=document.getElementById('endTime').value;
            if(!date||!name)return alert("–î–∞–Ω—ñ?"); 
            const r=await fetch('/api/shifts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date,name,start,end})}); 
            const d=await r.json(); if(d.pending)alert("–ù–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—ñ"); 
            loadShifts().then(renderCurrentShifts); 
        }
        async function addTask() {
            const title=document.getElementById('taskTitle').value; const date=document.getElementById('taskDate').value; const name=document.getElementById('taskEmployee').value;
            const isFullDay=document.getElementById('taskFullDay').checked; const start=document.getElementById('taskStart').value; const end=document.getElementById('taskEnd').value;
            if(!title||!date||!name)return alert("–î–∞–Ω—ñ?");
            await fetch('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title,date,name,isFullDay,start,end})});
            loadTasks().then(renderCurrentShifts);
        }
        async function delS(d,n){if(confirm("?")) await fetch('/api/delete-shift',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date:d,name:n})});loadShifts().then(renderCurrentShifts);}
        async function deleteTask(id){if(confirm("?")) await fetch('/api/tasks/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});loadTasks().then(renderCurrentShifts);}

        function renderCurrentShifts(){renderTimeline(globalShifts,null);renderCalendar();}
        function changeMonth(d){currentCalendarDate.setMonth(currentCalendarDate.getMonth()+d);renderCalendar();}
        function setMode(m){ 
            document.getElementById('listViewContainer').className = m === 'list' ? '' : 'hidden'; 
            document.getElementById('calendarViewContainer').className = m === 'list' ? 'hidden' : ''; 
            const btnList = document.getElementById('btnModeList');
            const btnCal = document.getElementById('btnModeCalendar');
            const activeClass = "flex-1 py-1.5 text-xs font-semibold rounded-[8px] bg-white dark:bg-[#636366] shadow-sm text-black dark:text-white";
            const inactiveClass = "flex-1 py-1.5 text-xs font-medium text-gray-500";
            if (m === 'list') { btnList.className = activeClass; btnCal.className = inactiveClass; } else { btnList.className = inactiveClass; btnCal.className = activeClass; }
            if(m === 'calendar') renderCalendar(); 
        }
        function toggleEditMode(){document.getElementById('adminPanel').classList.toggle('hidden');}
        function toggleTaskTimeInputs(){const c=document.getElementById('taskFullDay').checked;document.getElementById('taskTimeInputs').className=c?'hidden':'flex gap-3';}
        function showAdminTab(t){['shifts','tasks','requests'].forEach(x=>document.getElementById('adminTab'+x.charAt(0).toUpperCase()+x.slice(1)).classList.add('hidden'));document.getElementById('adminTab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('hidden');if(t==='requests')loadRequests();}
        function clearDay(){const d=document.getElementById('shiftDate').value; if(d&&confirm(`Clean ${d}?`))fetch('/api/shifts/clear-day',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date:d})}).then(()=>{loadShifts().then(renderCurrentShifts)});}
        function toggleArchive(){document.getElementById('archiveContainer').classList.toggle('hidden');}
        function downloadAllMyShifts(){if(!currentUser)return;const today=new Date().toISOString().split('T')[0];const myShifts=globalShifts.filter(s=>s.name===currentUser.name&&s.date>=today);if(myShifts.length===0)return alert('–ù–µ–º–∞—î –∑–º—ñ–Ω!');let ics="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Shifter//UA\n";myShifts.forEach(s=>{const start=s.date.replace(/-/g,'')+'T'+s.start.replace(':','')+'00';const end=s.date.replace(/-/g,'')+'T'+s.end.replace(':','')+'00';ics+=`BEGIN:VEVENT\nDTSTART:${start}\nDTEND:${end}\nSUMMARY:–†–æ–±–æ—Ç–∞\nEND:VEVENT\n`;});ics+="END:VCALENDAR";const a=document.createElement('a');a.href=window.URL.createObjectURL(new Blob([ics],{type:'text/calendar'}));a.download=`my-shifts.ics`;document.body.appendChild(a);a.click();document.body.removeChild(a);}

        checkAuth();
    </script>
</body>
</html>