<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shifter</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        ios: { bg: '#F2F2F7', card: '#FFFFFF', blue: '#007AFF', input: '#E5E5EA' },
                        darkios: { bg: '#000000', card: '#1C1C1E', input: '#2C2C2E' }
                    },
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        /* --- APPLE STYLES --- */
        .glass-header { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass-header { background: rgba(28, 28, 30, 0.85); border-bottom: 1px solid rgba(255,255,255,0.1); }

        .timeline-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; border-radius: 6px; overflow: hidden; position: relative; height: 12px; margin-bottom: 8px; }
        .timeline-mark { border-right: 1px solid rgba(0,0,0,0.05); height: 100%; }
        .dark .timeline-mark { border-right-color: rgba(255,255,255,0.05); }
        .timeline-mark:last-child { border-right: none; }
        
        .shift-bar { position: absolute; top: 0; bottom: 0; border-radius: 100px; opacity: 1; z-index: 10; transition: all 0.3s; }
        .task-bar { position: absolute; top: 2px; bottom: 2px; border-radius: 100px; z-index: 20; background-color: #BF5AF2; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .calendar-day { min-height: 85px; border-radius: 14px; padding: 6px; font-size: 13px; background: white; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.03); border: 1px solid transparent; }
        .dark .calendar-day { background: #1C1C1E; color: white; }
        .calendar-day.today { border: 2px solid #007AFF; }
        
        .work-badge { background-color: #007AFF15; color: #007AFF; padding: 3px 6px; border-radius: 6px; margin-top: 2px; text-align: center; font-size: 11px; font-weight: 600; }
        .dark .work-badge { background-color: #0A84FF20; color: #0A84FF; }
        
        .event-badge { background-color: #FFD60A20; color: #B49104; padding: 2px 5px; border-radius: 4px; font-size: 10px; margin-bottom: 2px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dark .event-badge { background-color: #FFD60A20; color: #FFD60A; }
        
        .task-badge-full { color: #BF5AF2; font-size: 10px; font-weight: 700; border: 1px solid #BF5AF2; padding: 1px 4px; border-radius: 4px; margin-bottom: 1px; }
        .dark .task-badge-full { color: #E9D5FF; border-color: #E9D5FF; }

        .ios-input { background: #E5E5EA; border: none; border-radius: 10px; padding: 10px 12px; width: 100%; font-size: 15px; outline: none; transition: background 0.2s; -webkit-appearance: none; }
        .ios-input:focus { background: #D1D1D6; }
        .dark .ios-input { background: #2C2C2E; color: white; }
        .dark .ios-input:focus { background: #3A3A3C; }

        .btn-primary { background: #007AFF; color: white; border-radius: 12px; font-weight: 600; padding: 12px; transition: opacity 0.2s; width: 100%; font-size: 16px; }
        .btn-primary:active { opacity: 0.7; }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="bg-[#F2F2F7] text-black dark:bg-black dark:text-white font-sans min-h-screen flex flex-col">

    <div id="loginScreen" class="flex-grow flex items-center justify-center p-6">
        <div class="bg-white dark:bg-[#1C1C1E] p-8 rounded-[24px] shadow-xl w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-blue-500 rounded-[18px] mx-auto mb-6 flex items-center justify-center text-3xl shadow-lg shadow-blue-500/30">üìÖ</div>
            <h1 class="text-3xl font-bold mb-2 tracking-tight">Shifter</h1>
            <p class="text-gray-400 mb-8 text-sm">–£–≤—ñ–π–¥—ñ—Ç—å –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –≥—Ä–∞—Ñ—ñ–∫—É</p>
            <div id="tgLoader" class="hidden mb-4 text-blue-500 font-medium animate-pulse">üîÑ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è...</div>
            <div id="loginForm" class="space-y-3">
                <input type="text" id="loginUser" placeholder="–õ–æ–≥—ñ–Ω" class="ios-input">
                <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å" class="ios-input">
                <button onclick="login()" class="btn-primary mt-4">–£–≤—ñ–π—Ç–∏</button>
                <p id="loginError" class="text-red-500 text-center mt-4 text-sm hidden"></p>
            </div>
        </div>
    </div>

    <div id="appScreen" class="hidden w-full pb-24">
        <nav class="glass-header px-4 py-3 sticky top-0 z-50 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gray-100 dark:bg-[#2C2C2E] rounded-full flex items-center justify-center text-lg">üë§</div>
                <div>
                    <h1 id="userNameDisplay" class="font-bold text-lg leading-tight tracking-tight">...</h1>
                    <div id="hoursDisplay" class="text-sm text-gray-500 font-medium hidden">0 –≥–æ–¥.</div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="toggleEditBtn" onclick="toggleEditMode()" class="hidden bg-gray-200 dark:bg-[#3A3A3C] text-black dark:text-white px-3 py-1.5 rounded-full text-xs font-bold transition">–ú–µ–Ω—é</button>
                <button onclick="logout()" class="text-blue-500 text-sm font-medium">–í–∏–π—Ç–∏</button>
            </div>
        </nav>

        <div class="container mx-auto p-4 max-w-lg space-y-4">
            
            <div id="userActionsPanel" class="hidden"></div>

            <div class="flex justify-between items-center bg-white dark:bg-[#1C1C1E] p-1.5 rounded-[14px] shadow-sm">
                <div class="flex bg-[#E5E5EA] dark:bg-[#2C2C2E] rounded-[10px] p-0.5 w-full">
                    <button onclick="setMode('list')" id="btnModeList" class="flex-1 py-1.5 text-xs font-semibold rounded-[8px] transition-all bg-white dark:bg-[#636366] shadow-sm">–°–ø–∏—Å–æ–∫</button>
                    <button onclick="setMode('calendar')" id="btnModeCalendar" class="flex-1 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 rounded-[8px] transition-all">–ö–∞–ª–µ–Ω–¥–∞—Ä</button>
                </div>
                <div class="flex items-center gap-3 ml-3 pr-1">
                    <button onclick="downloadAllMyShifts()" class="text-blue-500 text-xl">üì•</button>
                    <button onclick="toggleTheme()" class="text-gray-400 text-xl"><span id="themeIcon">üåô</span></button>
                </div>
            </div>

            <div id="filterContainer" class="bg-white dark:bg-[#1C1C1E] px-4 py-3 rounded-[18px] shadow-sm flex items-center justify-between">
                <span class="text-sm font-semibold text-gray-500">–§—ñ–ª—å—Ç—Ä</span>
                <select id="viewFilter" onchange="renderCurrentShifts()" class="bg-transparent text-blue-500 font-medium text-sm outline-none text-right w-2/3">
                    <option value="all">–í—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</option>
                </select>
            </div>

            <div id="adminPanel" class="hidden bg-white dark:bg-[#1C1C1E] p-5 rounded-[24px] shadow-lg border border-orange-100 dark:border-orange-900/30">
                <h2 class="text-xl font-bold text-black dark:text-white mb-4 tracking-tight">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h2>
                
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">
                    <button onclick="showAdminTab('shifts')" class="bg-[#F2F2F7] dark:bg-[#2C2C2E] text-black dark:text-white px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">–ì—Ä–∞—Ñ—ñ–∫</button>
                    <button onclick="showAdminTab('tasks')" class="bg-[#F2F2F7] dark:bg-[#2C2C2E] text-black dark:text-white px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">–ó–∞–¥–∞—á—ñ</button>
                    <button onclick="showAdminTab('events')" class="bg-[#F2F2F7] dark:bg-[#2C2C2E] text-black dark:text-white px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">–ü–æ–¥—ñ—ó</button>
                    <button id="tabRequestsBtn" onclick="showAdminTab('requests')" class="hidden bg-red-100 text-red-600 px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">–ó–∞–ø–∏—Ç–∏</button>
                </div>

                <div id="adminTabShifts" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3"><input type="date" id="shiftDate" class="ios-input"><select id="employeeSelect" class="ios-input bg-transparent"><option value="" disabled selected>–•—Ç–æ?</option></select></div>
                    <div class="flex gap-3 items-center"><input type="time" id="startTime" class="ios-input text-center" value="10:00"><span class="text-gray-300">to</span><input type="time" id="endTime" class="ios-input text-center" value="20:00"></div>
                    <button onclick="addShift()" class="btn-primary bg-orange-500 hover:bg-orange-600">–î–æ–¥–∞—Ç–∏ –∑–º—ñ–Ω—É</button>
                    <div id="adminOnlyFunctions" class="hidden pt-4 border-t border-gray-100 dark:border-gray-800">
                        <div class="grid grid-cols-2 gap-3"><button onclick="clearDay()" class="text-xs text-red-500 bg-red-50 dark:bg-red-900/20 py-3 rounded-xl font-medium">–û—á–∏—Å—Ç–∏—Ç–∏ –¥–µ–Ω—å</button><button onclick="clearMonth()" class="text-xs text-red-500 bg-red-50 dark:bg-red-900/20 py-3 rounded-xl font-medium">–û—á–∏—Å—Ç–∏—Ç–∏ –º—ñ—Å—è—Ü—å</button></div>
                        <button onclick="toggleImport()" class="text-xs text-blue-500 underline block mt-2 text-center w-full">–ú–∞—Å–æ–≤–∏–π —ñ–º–ø–æ—Ä—Ç</button>
                        <div id="bulkImportForm" class="hidden mt-2"><textarea id="bulkText" rows="3" class="ios-input font-mono text-xs"></textarea><button onclick="uploadBulk()" class="btn-primary mt-2 bg-green-500">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button></div>
                    </div>
                </div>

                <div id="adminTabTasks" class="hidden space-y-3">
                    <input type="text" id="taskTitle" placeholder="–ù–∞–∑–≤–∞ –∑–∞–¥–∞—á—ñ" class="ios-input">
                    <div class="grid grid-cols-2 gap-3"><input type="date" id="taskDate" class="ios-input"><select id="taskEmployee" class="ios-input bg-transparent"><option value="" disabled selected>–ö–æ–º—É?</option></select></div>
                    <div class="flex items-center justify-between bg-[#F2F2F7] dark:bg-[#2C2C2E] p-3 rounded-xl"><span class="text-sm font-medium">–í–µ—Å—å –¥–µ–Ω—å</span><input type="checkbox" id="taskFullDay" onchange="toggleTaskTimeInputs()" class="w-5 h-5 accent-purple-500"></div>
                    <div id="taskTimeInputs" class="flex gap-3 items-center"><input type="time" id="taskStart" class="ios-input text-center" value="12:00"><span class="text-gray-300">to</span><input type="time" id="taskEnd" class="ios-input text-center" value="14:00"></div>
                    <button onclick="addTask()" class="btn-primary bg-purple-500 hover:bg-purple-600">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏</button>
                </div>

                <div id="adminTabEvents" class="hidden space-y-3">
                    <input type="text" id="eventTitle" placeholder="–ü–æ–¥—ñ—è" class="ios-input">
                    <div class="grid grid-cols-2 gap-3"><input type="date" id="eventDate" class="ios-input"><select id="eventRepeat" class="ios-input bg-transparent"><option value="none">–ë–µ–∑ –ø–æ–≤—Ç–æ—Ä—É</option><option value="weekly">–©–æ—Ç–∏–∂–Ω—è</option><option value="monthly">–©–æ–º—ñ—Å—è—Ü—è</option><option value="yearly">–©–æ—Ä–æ–∫—É</option></select></div>
                    <button onclick="addEvent()" class="btn-primary bg-yellow-500 hover:bg-yellow-600 text-black">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                    <div id="eventListAdmin" class="mt-4 space-y-2"></div>
                </div>

                <div id="adminTabRequests" class="hidden space-y-3">
                    <button onclick="approveAllRequests()" class="btn-primary bg-green-500 hover:bg-green-600">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –í—Å—ñ</button>
                    <div id="requestsList" class="space-y-3"></div>
                </div>
            </div>

            <div id="listViewContainer">
                <button id="archiveToggleBtn" onclick="toggleArchive()" class="hidden w-full text-center text-xs text-gray-400 py-3 hover:text-gray-600 transition">–ü–æ–∫–∞–∑–∞—Ç–∏ –º–∏–Ω—É–ª—ñ (<span id="archiveCount">0</span>)</button>
                <div id="archiveContainer" class="hidden space-y-3 mb-3 opacity-60 grayscale"></div>
                <div id="scheduleView" class="space-y-3"></div>
            </div>

            <div id="calendarViewContainer" class="hidden bg-white dark:bg-[#1C1C1E] p-4 rounded-[24px] shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="changeMonth(-1)" class="text-blue-500 text-xl font-bold px-2">‚Äπ</button>
                    <h2 id="calendarTitle" class="font-bold text-xl capitalize tracking-tight"></h2>
                    <button onclick="changeMonth(1)" class="text-blue-500 text-xl font-bold px-2">‚Ä∫</button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-[11px] font-semibold text-gray-400 uppercase mb-2"><div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div class="text-red-400">–ù–¥</div></div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        if (tg.platform && tg.platform !== 'unknown') { try { tg.expand(); tg.enableClosingConfirmation(); } catch(e){} }

        let currentUser = null; let globalShifts = []; let globalUsers = []; let globalEvents = []; let globalTasks = [];
        const START_HOUR = 10; const END_HOUR = 20; const TOTAL_HOURS = END_HOUR - START_HOUR;
        let currentCalendarDate = new Date();

        function initTheme() {
            if ((tg.platform !== 'unknown' && tg.colorScheme === 'dark') || localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { 
                document.documentElement.classList.add('dark'); document.getElementById('themeIcon').innerText = '‚òÄÔ∏è'; 
                if(tg.platform!=='unknown'){tg.setHeaderColor('#1C1C1E'); tg.setBackgroundColor('#000000');}
            } else { 
                document.documentElement.classList.remove('dark'); document.getElementById('themeIcon').innerText = 'üåô'; 
                if(tg.platform!=='unknown'){tg.setHeaderColor('#FFFFFF'); tg.setBackgroundColor('#F2F2F7');}
            }
        }
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) { html.classList.remove('dark'); localStorage.theme = 'light'; document.getElementById('themeIcon').innerText = 'üåô'; if(tg.platform!=='unknown'){tg.setHeaderColor('#FFFFFF'); tg.setBackgroundColor('#F2F2F7');} } 
            else { html.classList.add('dark'); localStorage.theme = 'dark'; document.getElementById('themeIcon').innerText = '‚òÄÔ∏è'; if(tg.platform!=='unknown'){tg.setHeaderColor('#1C1C1E'); tg.setBackgroundColor('#000000');} }
        }
        initTheme();

        // --- AUTH ---
        async function checkAuth() { 
            try { 
                const res = await fetch('/api/me'); const data = await res.json(); 
                if (data.loggedIn) { showApp(data.user); return; } 
            } catch (e) {}
            
            if (tg.platform && tg.platform !== 'unknown' && tg.initDataUnsafe?.user?.id) {
                document.getElementById('loginForm').classList.add('hidden'); document.getElementById('tgLoader').classList.remove('hidden');
                try {
                    const res = await fetch('/api/login-telegram', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telegramId: tg.initDataUnsafe.user.id }) });
                    const data = await res.json();
                    if (data.success) showApp(data.user); else { document.getElementById('tgLoader').classList.add('hidden'); document.getElementById('loginForm').classList.remove('hidden'); }
                } catch (e) { document.getElementById('tgLoader').classList.add('hidden'); document.getElementById('loginForm').classList.remove('hidden'); }
            } else { showLogin(); }
        }

        async function login() {
            const username = document.getElementById('loginUser').value; const password = document.getElementById('loginPass').value;
            try { 
                const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
                const data = await res.json();
                if (data.success) showApp(data.user); else { document.getElementById('loginError').innerText = data.message; document.getElementById('loginError').classList.remove('hidden'); }
            } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è"); }
        }

        async function logout() { await fetch('/api/logout', { method: 'POST' }); window.location.reload(); }
        function showLogin() { currentUser = null; document.getElementById('appScreen').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); }

        // --- MAIN APP INIT ---
        function showApp(user) {
            currentUser = user; 
            document.getElementById('loginScreen').classList.add('hidden'); 
            document.getElementById('appScreen').classList.remove('hidden');
            
            // FIX: NAME (Second Word)
            const parts = user.name.split(' ');
            const shortName = parts.length > 1 ? parts[1] : parts[0];
            document.getElementById('userNameDisplay').innerText = `–ü—Ä–∏–≤—ñ—Ç, ${shortName}`; 
            
            document.getElementById('userActionsPanel').classList.remove('hidden');
            
            // PERMISSIONS
            if (['admin', 'SM', 'SSE'].includes(user.role)) {
                document.getElementById('toggleEditBtn').classList.remove('hidden');
                if (['SM', 'admin'].includes(user.role)) { 
                    document.getElementById('tabRequestsBtn').classList.remove('hidden'); 
                    document.getElementById('adminOnlyFunctions').classList.remove('hidden'); 
                    loadRequests(); 
                } else { 
                    document.getElementById('tabRequestsBtn').classList.add('hidden'); 
                    document.getElementById('adminOnlyFunctions').classList.add('hidden'); 
                }
            } else { 
                document.getElementById('toggleEditBtn').classList.add('hidden'); 
            }
            
            Promise.all([loadEmployeeList(), loadShifts(), loadEvents(), loadTasks()]).then(() => { 
                calculateHours(); 
                renderCurrentShifts(); 
                if(['admin','SM','SSE'].includes(user.role)) renderAdminEventList(); 
            });
        }

        // --- FIX: MENU TOGGLE LOGIC ---
        function toggleEditMode() {
            const panel = document.getElementById('adminPanel');
            const btn = document.getElementById('toggleEditBtn');
            
            // Simple class toggle for visibility
            panel.classList.toggle('hidden');
            
            // Visual feedback for Button
            if (!panel.classList.contains('hidden')) {
                // Active State (Blue)
                btn.classList.remove('bg-gray-200', 'dark:bg-[#3A3A3C]', 'text-black', 'dark:text-white');
                btn.classList.add('bg-[#007AFF]', 'text-white');
            } else {
                // Inactive State (Gray)
                btn.classList.remove('bg-[#007AFF]', 'text-white');
                btn.classList.add('bg-gray-200', 'dark:bg-[#3A3A3C]', 'text-black', 'dark:text-white');
            }
        }

        // --- LOADERS (FROM WORKING CODE) ---
        async function loadEmployeeList() { const res = await fetch('/api/users'); const allUsers = await res.json(); const workers = allUsers.filter(u => u.role !== 'admin'); globalUsers = workers; const adminSelect = document.getElementById('employeeSelect'); adminSelect.innerHTML = '<option value="" disabled selected>–•—Ç–æ?</option>'; const taskSelect = document.getElementById('taskEmployee'); taskSelect.innerHTML = '<option value="" disabled selected>–ö–æ–º—É?</option>'; const filterSelect = document.getElementById('viewFilter'); filterSelect.innerHTML = '<option value="all">üë• –í—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</option>'; workers.forEach(w => { const opt1 = document.createElement('option'); opt1.value = w.name; opt1.innerText = w.name; adminSelect.appendChild(opt1); const optT = document.createElement('option'); optT.value = w.name; optT.innerText = w.name; taskSelect.appendChild(optT); const opt2 = document.createElement('option'); opt2.value = w.name; opt2.innerText = w.name; filterSelect.appendChild(opt2); }); }
        async function loadShifts() { const response = await fetch('/api/shifts'); if (response.status === 403) {logout(); return;} if(response.ok) globalShifts = await response.json(); }
        async function loadEvents() { const res = await fetch('/api/events'); globalEvents = await res.json(); }
        async function loadTasks() { const res = await fetch('/api/tasks'); globalTasks = await res.json(); }
        async function loadRequests() { const res = await fetch('/api/requests'); const requests = await res.json(); const container = document.getElementById('requestsList'); container.innerHTML = ''; if (requests.length === 0) { container.innerHTML = '<p class="text-gray-500 text-xs text-center">–ó–∞–ø–∏—Ç—ñ–≤ –Ω–µ–º–∞—î</p>'; return; } requests.forEach(req => { let desc = ''; if(req.type === 'add_shift') desc = `‚ûï –ó–º—ñ–Ω–∞: ${req.data.date}, ${req.data.name}`; else if(req.type === 'del_shift') desc = `‚ùå –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–º—ñ–Ω–∏: ${req.data.details}`; else if(req.type === 'add_task') desc = `‚ûï –ó–∞–¥–∞—á–∞: ${req.data.title}`; else if(req.type === 'del_task') desc = `‚ùå –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–¥–∞—á—ñ: ${req.data.details}`; else desc = `–Ü–Ω—à–µ: ${req.type}`; container.innerHTML += `<div class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-xs flex justify-between items-center shadow-sm"><div><div class="font-bold text-gray-700 dark:text-gray-200">${desc}</div><div class="text-[10px] text-gray-500">–í—ñ–¥: ${req.createdBy}</div></div><div class="flex gap-2"><button onclick="handleRequest('${req._id}', 'approve')" class="text-green-600 font-bold border border-green-200 bg-green-50 px-2 py-1 rounded">‚úÖ</button><button onclick="handleRequest('${req._id}', 'reject')" class="text-red-600 font-bold border border-red-200 bg-red-50 px-2 py-1 rounded">‚ùå</button></div></div>`; }); }

        // --- RENDER (ONLY VISUAL CHANGES HERE) ---
        function calculateHours(){if(!currentUser)return;const now=new Date();const cm=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;const ms=globalShifts.filter(s=>s.name===currentUser.name&&s.date.startsWith(cm));let tm=0;ms.forEach(s=>{const [sh,sm]=s.start.split(':').map(Number);const [eh,em]=s.end.split(':').map(Number);tm+=((eh*60+em)-(sh*60+sm));});const h=Math.floor(tm/60);document.getElementById('hoursDisplay').innerText=`${h} –≥–æ–¥–∏–Ω`;document.getElementById('hoursDisplay').classList.remove('hidden');}
        
        function renderTimeline(shifts, filterUser) {
            const mainContainer = document.getElementById('scheduleView'); const archiveContainer = document.getElementById('archiveContainer'); const archiveBtn = document.getElementById('archiveToggleBtn'); const archiveCount = document.getElementById('archiveCount'); mainContainer.innerHTML = ''; archiveContainer.innerHTML = '';
            const uniqueDates = [...new Set(shifts.map(s => s.date))].sort(); const todayStr = new Date().toISOString().split('T')[0]; if (!uniqueDates.includes(todayStr)) uniqueDates.push(todayStr); uniqueDates.sort(); let pastDaysCount = 0; let todayElementId = null;
            
            uniqueDates.forEach(dateStr => {
                const isPast = dateStr < todayStr; const isToday = dateStr === todayStr; const dayEvents = getEventsForDate(dateStr);
                
                // APPLE CARD STYLE
                const dayBlock = document.createElement('div'); 
                dayBlock.className = 'bg-white dark:bg-[#1C1C1E] rounded-[24px] shadow-sm p-4';
                if (isToday) { dayBlock.classList.add('ring-2', 'ring-blue-500'); dayBlock.id = "todayBlock"; todayElementId = "todayBlock"; }
                
                const dayDateObj = new Date(dateStr); const dayName = dayDateObj.toLocaleDateString('uk-UA', { weekday: 'long', day: 'numeric', month: 'long' }); 
                let eventsHtml = ''; dayEvents.forEach(ev => { eventsHtml += `<span class="event-badge ml-2">üìå ${ev.title}</span>`; });
                
                dayBlock.innerHTML = `<div class="flex justify-between items-center mb-3 border-b border-gray-100 dark:border-gray-800 pb-2"><span class="font-bold text-lg capitalize tracking-tight ${isToday?'text-blue-500':'text-black dark:text-white'}">${dayName} ${isToday ? '<span class="bg-blue-500 text-white text-[10px] px-2 py-0.5 rounded-full ml-1 align-middle">–°—å–æ–≥–æ–¥–Ω—ñ</span>' : ''}</span><div>${eventsHtml}</div></div>`;
                
                const dayContent = document.createElement('div'); dayContent.className = 'space-y-4'; 
                let usersToShow = (filterUser === 'all') ? globalUsers : globalUsers.filter(u => u.name === filterUser); const shiftsOnThisDay = shifts.filter(s => s.date === dateStr); 
                usersToShow.sort((a, b) => { const aWork = shiftsOnThisDay.find(s => s.name === a.name); const bWork = shiftsOnThisDay.find(s => s.name === b.name); if (aWork && !bWork) return -1; if (!aWork && bWork) return 1; return a.name.localeCompare(b.name); });
                
                let hasAnyInfo = false;
                usersToShow.forEach(user => {
                    const shift = shiftsOnThisDay.find(s => s.name === user.name); const userTasks = globalTasks.filter(t => t.date === dateStr && t.name === user.name); if (shift || userTasks.length > 0) hasAnyInfo = true;
                    
                    const nameParts = user.name.split(' ');
                    const shortName = nameParts.length > 1 ? nameParts[1] : nameParts[0];

                    if (shift) {
                        const isMe = shift.name === currentUser.name; const [sH, sM] = shift.start.split(':').map(Number); const [eH, eM] = shift.end.split(':').map(Number); const startH = sH + sM/60; const endH = eH + eM/60; let left = ((startH - START_HOUR) / TOTAL_HOURS) * 100; let width = ((endH - startH) / TOTAL_HOURS) * 100; if (left < 0) { width += left; left = 0; } if (left + width > 100) width = 100 - left; 
                        const barColor = isMe ? 'bg-blue-500' : 'bg-green-500'; const nameColor = isMe ? 'text-blue-500 font-bold' : 'text-gray-900 dark:text-gray-200 font-medium';
                        let taskBadges = ''; let taskBars = ''; 
                        userTasks.forEach(task => { if (task.isFullDay) { taskBadges += `<span class="task-badge-full ml-2">‚òÖ ${task.title}</span>`; } else { const [tsH, tsM] = task.start.split(':').map(Number); const [teH, teM] = task.end.split(':').map(Number); const tStartH = tsH + tsM/60; const tEndH = teH + teM/60; let tLeft = ((tStartH - START_HOUR) / TOTAL_HOURS) * 100; let tWidth = ((tEndH - tStartH) / TOTAL_HOURS) * 100; if (tLeft < 0) { tWidth += tLeft; tLeft = 0; } if (tLeft + tWidth > 100) tWidth = 100 - tLeft; const delBtn = (currentUser.role==='admin'||currentUser.role==='SM'||currentUser.role==='SSE') ? `onclick="deleteTask('${task._id}')" style="cursor:pointer;"` : ''; taskBars += `<div class="task-bar flex items-center justify-center text-[9px] text-white font-bold overflow-hidden" ${delBtn} style="left: ${tLeft}%; width: ${tWidth}%;">${task.title}</div>`; } });
                        
                        const delS = (['admin','SM','SSE'].includes(currentUser.role)) ? `<button onclick="deleteShiftInGroup('${shift.date}', '${shift.name}')" class="ml-2 text-gray-400 hover:text-red-500 text-xs">‚úï</button>` : '';

                        dayContent.innerHTML += `<div><div class="flex items-center justify-between text-xs mb-1 ${nameColor}"><div class="flex items-center"><span class="text-sm">${shortName}</span> <span class="text-gray-400 dark:text-gray-500 ml-2 font-mono text-[10px]">${shift.start}-${shift.end}</span>${taskBadges}</div>${delS}</div><div class="timeline-grid">${Array(10).fill('<div class="timeline-mark"></div>').join('')}<div class="shift-bar ${barColor}" style="left: ${left}%; width: ${width}%;"></div>${taskBars}</div></div>`;
                    } else if (userTasks.length > 0) {
                        let taskBadges = ''; userTasks.forEach(task => taskBadges += `<span class="task-badge-full ml-2">‚òÖ ${task.title}</span>`); 
                        dayContent.innerHTML += `<div class="opacity-70"><div class="flex items-center text-xs mb-1 text-gray-500 dark:text-gray-400"><span>${shortName}</span> <span class="ml-1">–í–∏—Ö—ñ–¥–Ω–∏–π</span>${taskBadges}</div><div class="h-1 bg-gray-100 dark:bg-gray-800 rounded w-full"></div></div>`;
                    }
                });
                if (hasAnyInfo) { dayBlock.appendChild(dayContent); if (isPast) { archiveContainer.appendChild(dayBlock); pastDaysCount++; } else { mainContainer.appendChild(dayBlock); } }
            });
            if (pastDaysCount > 0) { archiveBtn.classList.remove('hidden'); archiveCount.innerText = pastDaysCount; } else { archiveBtn.classList.add('hidden'); } if (todayElementId) { setTimeout(() => { const el = document.getElementById(todayElementId); if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 500); }
        }

        // --- ACTIONS (FROM WORKING CODE) ---
        async function handleRequest(id, action) { await fetch('/api/requests/action', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, action }) }); loadRequests(); loadShifts(); loadTasks(); loadEvents(); setTimeout(() => renderCurrentShifts(), 500); }
        async function approveAllRequests() { if(!confirm("–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –í–°–Ü –∑–∞–ø–∏—Ç–∏ —Å–ø–∏—Å–∫–æ–º?")) return; await fetch('/api/requests/approve-all', { method: 'POST' }); loadRequests(); loadShifts(); loadTasks(); setTimeout(() => renderCurrentShifts(), 500); }
        async function addShift() { const date = document.getElementById('shiftDate').value; const name = document.getElementById('employeeSelect').value; const start = document.getElementById('startTime').value; const end = document.getElementById('endTime').value; if (!date || !name || !start || !end) return alert("–ó–∞–ø–æ–≤–Ω–∏ –≤—Å–µ!"); const res = await fetch('/api/shifts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date, name, start, end }) }); const data = await res.json(); if (data.pending) alert("‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è SM!"); else alert("‚úÖ –ó–º—ñ–Ω—É –¥–æ–¥–∞–Ω–æ!"); loadShifts().then(() => renderCurrentShifts()); }
        async function addTask() { const title = document.getElementById('taskTitle').value; const date = document.getElementById('taskDate').value; const name = document.getElementById('taskEmployee').value; const isFullDay = document.getElementById('taskFullDay').checked; const start = document.getElementById('taskStart').value; const end = document.getElementById('taskEnd').value; if(!title || !date || !name) return alert("–ó–∞–ø–æ–≤–Ω–∏ –≤—Å–µ!"); const res = await fetch('/api/tasks', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, date, name, isFullDay, start, end }) }); const data = await res.json(); if (data.pending) alert("‚úÖ –ó–∞–¥–∞—á–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è!"); else alert("‚úÖ –ó–∞–¥–∞—á—É –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ!"); loadTasks().then(() => renderCurrentShifts()); }
        async function deleteShiftInGroup(date, name) { const res = await fetch('/api/shifts'); const allShifts = await res.json(); const shift = allShifts.find(s => s.date === date && s.name === name); if (shift && confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –∑–º—ñ–Ω—É?")) { const r = await fetch('/api/delete-shift', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: shift._id }) }); const d = await r.json(); if(d.pending) alert("‚ùå –ó–∞–ø–∏—Ç –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ SM."); else loadShifts().then(() => renderCurrentShifts()); } }
        async function deleteTask(id) { if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–¥–∞—á—É?")) return; const r = await fetch('/api/tasks/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) }); const d = await r.json(); if(d.pending) alert("‚ùå –ó–∞–ø–∏—Ç –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ SM."); else loadTasks().then(() => renderCurrentShifts()); }
        function showAdminTab(tab) { document.getElementById('adminTabShifts').classList.add('hidden'); document.getElementById('adminTabEvents').classList.add('hidden'); document.getElementById('adminTabTasks').classList.add('hidden'); document.getElementById('adminTabRequests').classList.add('hidden'); if(tab === 'shifts') document.getElementById('adminTabShifts').classList.remove('hidden'); else if(tab === 'events') document.getElementById('adminTabEvents').classList.remove('hidden'); else if(tab === 'tasks') document.getElementById('adminTabTasks').classList.remove('hidden'); else if(tab === 'requests') { document.getElementById('adminTabRequests').classList.remove('hidden'); loadRequests(); } }
        function toggleTaskTimeInputs(){const c=document.getElementById('taskFullDay').checked;const i=document.getElementById('taskTimeInputs');if(c)i.classList.add('opacity-30','pointer-events-none');else i.classList.remove('opacity-30','pointer-events-none');}
        function toggleArchive(){document.getElementById('archiveContainer').classList.toggle('hidden');}
        function renderCurrentShifts(){renderTimeline(globalShifts,document.getElementById('viewFilter').value);renderCalendar();}
        function setMode(m){const l=document.getElementById('listViewContainer');const c=document.getElementById('calendarViewContainer');const f=document.getElementById('filterContainer');const b1=document.getElementById('btnModeList');const b2=document.getElementById('btnModeCalendar'); if(m==='list'){l.classList.remove('hidden');c.classList.add('hidden');f.classList.remove('hidden');b1.className="flex-1 py-1.5 text-xs font-semibold rounded-[8px] transition-all bg-white dark:bg-[#636366] shadow-sm";b2.className="flex-1 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 rounded-[8px] transition-all";}else{l.classList.add('hidden');c.classList.remove('hidden');f.classList.add('hidden');b2.className="flex-1 py-1.5 text-xs font-semibold rounded-[8px] transition-all bg-white dark:bg-[#636366] shadow-sm";b1.className="flex-1 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 rounded-[8px] transition-all";renderCalendar();}}
        function toggleImport(){document.getElementById('bulkImportForm').classList.toggle('hidden');}
        async function uploadBulk(){const text=document.getElementById('bulkText').value.trim();if(!text)return;const shifts=[];text.split('\n').forEach(line=>{const parts=line.split(',');if(parts.length>=4)shifts.push({date:parts[0].trim(),name:parts[1].trim(),start:parts[2].trim(),end:parts[3].trim()});});if(shifts.length===0)return alert('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç!');await fetch('/api/shifts/bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({shifts})});document.getElementById('bulkText').value='';toggleImport();loadShifts().then(()=>renderCurrentShifts());}
        async function clearDay(){const date=document.getElementById('shiftDate').value;if(!date)return alert('–û–±–µ—Ä–∏ –¥–∞—Ç—É!');if(!confirm(`–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –∑–º—ñ–Ω–∏ –∑–∞ ${date}?`))return;await fetch('/api/shifts/clear-day',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date})});loadShifts().then(()=>renderCurrentShifts());}
        async function clearMonth(){const date=document.getElementById('shiftDate').value;if(!date)return alert('–û–±–µ—Ä–∏ –¥–∞—Ç—É!');const month=date.substring(0,7);if(!confirm(`–£–í–ê–ì–ê! –í–∏–¥–∞–ª–∏—Ç–∏ –í–ï–°–¨ –≥—Ä–∞—Ñ—ñ–∫ –∑–∞ –º—ñ—Å—è—Ü—å ${month}?`))return;await fetch('/api/shifts/clear-month',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({month})});loadShifts().then(()=>renderCurrentShifts());}
        function downloadAllMyShifts(){if(!currentUser)return;const today=new Date().toISOString().split('T')[0];const myShifts=globalShifts.filter(s=>s.name===currentUser.name&&s.date>=today);if(myShifts.length===0)return alert('–ù–µ–º–∞—î –∑–º—ñ–Ω!');let ics="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Shifter//UA\n";myShifts.forEach(s=>{const start=s.date.replace(/-/g,'')+'T'+s.start.replace(':','')+'00';const end=s.date.replace(/-/g,'')+'T'+s.end.replace(':','')+'00';ics+=`BEGIN:VEVENT\nDTSTART:${start}\nDTEND:${end}\nSUMMARY:–†–æ–±–æ—Ç–∞\nEND:VEVENT\n`;});ics+="END:VCALENDAR";const a=document.createElement('a');a.href=window.URL.createObjectURL(new Blob([ics],{type:'text/calendar'}));a.download=`my-shifts.ics`;document.body.appendChild(a);a.click();document.body.removeChild(a);}

        checkAuth();
    </script>
</body>
</html>