<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shifter</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üóìÔ∏è</text></svg>">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        ios: { bg: '#F2F2F7', card: '#FFFFFF', input: '#E5E5EA' },
                        darkios: { bg: '#000000', card: '#1C1C1E', input: '#2C2C2E' }
                    },
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] },
                    animation: {
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(30px)', opacity: 0 },
                            '100%': { transform: 'translateY(0)', opacity: 1 },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; transition: background-color 0.5s, color 0.5s; }
        
        /* HEAVY GLASS */
        .glass-header { 
            background: rgba(255, 255, 255, 0.65); 
            backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(0,0,0,0.05); 
            transition: background 0.5s;
        }
        .dark .glass-header { 
            background: rgba(28, 28, 30, 0.65); 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
        }
        
        .glass-panel { 
            background: rgba(255, 255, 255, 0.7); 
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); 
            transition: background 0.5s;
        }
        .dark .glass-panel { background: rgba(28, 28, 30, 0.7); }

        .glass-modal { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); 
        }
        .dark .glass-modal { background: rgba(28, 28, 30, 0.85); }

        .ios-card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); transition: transform 0.1s, background 0.5s; }
        .dark .ios-card { background: #1C1C1E; box-shadow: none; }
        .ios-card:active { transform: scale(0.98); }

        .btn-primary { 
            background: linear-gradient(135deg, #007AFF, #0056b3); 
            color: white; border-radius: 14px; font-weight: 600; padding: 12px; width: 100%; 
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3); transition: all 0.2s;
        }
        .btn-primary:active { transform: scale(0.96); box-shadow: 0 2px 5px rgba(0, 122, 255, 0.2); }

        /* Animation Stagger */
        .stagger-1 { animation-delay: 0.05s; }
        .stagger-2 { animation-delay: 0.1s; }
        .stagger-3 { animation-delay: 0.15s; }
        .stagger-4 { animation-delay: 0.2s; }
        .stagger-5 { animation-delay: 0.25s; }

        .timeline-track { position: relative; height: 28px; background: #F3F4F6; border-radius: 10px; overflow: hidden; width: 100%; margin-top: 6px; }
        .dark .timeline-track { background: #2C2C2E; }
        .timeline-grid-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: grid; grid-template-columns: repeat(10, 1fr); pointer-events: none; }
        .timeline-line { border-right: 1px dashed rgba(0,0,0,0.05); height: 100%; }
        .dark .timeline-line { border-color: rgba(255,255,255,0.05); }
        
        /* UPDATED GRADIENTS (STRONGER) */
        .shift-segment { 
            position: absolute; top: 0; bottom: 0; 
            background: linear-gradient(90deg, #2563EB, #1E40AF); /* Strong Blue */
            border-radius: 8px; z-index: 10; opacity: 0.95; 
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.4);
        }
        .shift-segment.my-shift { 
            background: linear-gradient(90deg, #16A34A, #15803D); /* Vivid Green */
            box-shadow: 0 2px 8px rgba(22, 163, 74, 0.5); 
        }
        .shift-segment.vacation-segment { 
            background: linear-gradient(90deg, #0D9488, #115E59); /* Deep Teal */
            width: 100% !important; left: 0 !important; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 10px; font-weight: bold; color: white; letter-spacing: 1px; text-transform: uppercase;
            box-shadow: 0 2px 6px rgba(13, 148, 136, 0.4);
        }

        .task-segment { position: absolute; top: 2px; bottom: 2px; background: linear-gradient(135deg, #A855F7, #7C3AED); border-radius: 6px; z-index: 20; box-shadow: 0 2px 4px rgba(124, 58, 237, 0.4); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 9px; font-weight: 800; display: flex; align-items: center; justify-content: center; overflow: hidden; white-space: nowrap; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; }
        .task-segment:active { transform: scale(0.95); }
        
        .ios-input { background: #E5E5EA; border: none; border-radius: 12px; padding: 12px 16px; width: 100%; font-size: 16px; outline: none; transition: background 0.2s; }
        .dark .ios-input { background: #2C2C2E; color: white; } .dark .ios-input:focus { background: #3A3A3C; }
        .skeleton { background: #E5E5EA; border-radius: 12px; } .dark .skeleton { background: #2C2C2E; }

        /* TOGGLE SWITCH (Admin Menu) */
        .toggle-checkbox { display: none; }
        .toggle-label {
            width: 50px; height: 30px; background: #E5E5EA; border-radius: 50px; position: relative; cursor: pointer; transition: background 0.3s;
        }
        .dark .toggle-label { background: #3A3A3C; }
        .toggle-label::after {
            content: "‚úèÔ∏è"; display: flex; align-items: center; justify-content: center; font-size: 12px;
            width: 26px; height: 26px; background: white; border-radius: 50%; 
            position: absolute; top: 2px; left: 2px; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .toggle-checkbox:checked + .toggle-label { background: #34C759; }
        .toggle-checkbox:checked + .toggle-label::after { transform: translateX(20px); }

        /* CALENDAR */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1/1; min-height: 50px; border-radius: 12px; padding: 4px; font-size: 12px; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(0,0,0,0.05); transition: all 0.2s; position: relative; overflow: hidden; }
        .dark .calendar-day { background: rgba(28, 28, 30, 0.5); border-color: rgba(255,255,255,0.05); color: #E5E5EA; }
        .calendar-day.today { border: 2px solid #007AFF; box-shadow: 0 0 10px rgba(0, 122, 255, 0.2); }
        .calendar-day.my-work-day { background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.2)); border: 1px solid rgba(16, 185, 129, 0.3); color: #065F46; }
        .dark .calendar-day.my-work-day { background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.3)); color: #D1FAE5; }
        .calendar-day.vacation-day { background: linear-gradient(135deg, rgba(20, 184, 166, 0.15), rgba(13, 148, 136, 0.2)); border: 1px solid rgba(20, 184, 166, 0.3); color: #0F766E; }
        .dark .calendar-day.vacation-day { background: linear-gradient(135deg, rgba(20, 184, 166, 0.2), rgba(13, 148, 136, 0.3)); color: #CCFBF1; }
        .work-badge { font-size: 9px; font-weight: 700; margin-top: auto; margin-bottom: 2px; padding: 2px 4px; border-radius: 4px; text-align: center; width: 100%; }
        .calendar-day.my-work-day .work-badge { background: rgba(16, 185, 129, 0.2); color: #047857; }
        .dark .calendar-day.my-work-day .work-badge { background: rgba(16, 185, 129, 0.3); color: #6EE7B7; }
        .calendar-day.vacation-day .work-badge { background: rgba(20, 184, 166, 0.2); color: #0F766E; }
        .dark .calendar-day.vacation-day .work-badge { background: rgba(20, 184, 166, 0.3); color: #5EEAD4; }
    </style>
</head>
<body class="bg-[#F2F2F7] text-black dark:bg-black dark:text-white font-sans min-h-screen flex flex-col selection:bg-blue-500 selection:text-white">

    <div id="skeletonLoader" class="fixed inset-0 z-50 p-4 space-y-4 bg-[#F2F2F7] dark:bg-black flex flex-col">
        <div class="h-14 w-full skeleton animate-pulse"></div>
        <div class="h-12 w-full skeleton animate-pulse"></div>
        <div class="space-y-4 flex-1 mt-4">
            <div class="h-32 w-full skeleton animate-pulse"></div>
            <div class="h-32 w-full skeleton animate-pulse"></div>
            <div class="h-32 w-full skeleton animate-pulse"></div>
        </div>
    </div>

    <div id="loginScreen" class="hidden flex-grow flex items-center justify-center p-6">
        <div class="ios-card p-8 w-full max-w-sm text-center">
            <h1 class="text-4xl font-bold mb-2 tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-indigo-600">Shifter</h1>
            <p class="text-gray-400 mb-8 text-sm">–£–≤—ñ–π–¥—ñ—Ç—å –¥–ª—è –¥–æ—Å—Ç—É–ø—É</p>
            <div id="loginForm" class="space-y-3">
                <input type="text" id="loginUser" placeholder="–õ–æ–≥—ñ–Ω" class="ios-input">
                <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å" class="ios-input">
                <button onclick="login()" class="btn-primary mt-4 shadow-lg shadow-blue-500/30">–£–≤—ñ–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <div id="appScreen" class="hidden w-full pb-24 relative opacity-0 transition-opacity duration-500">
        <nav class="glass-header px-4 py-3 sticky top-0 z-40 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gray-100 dark:bg-[#2C2C2E] rounded-full overflow-hidden flex items-center justify-center text-lg border border-gray-200 dark:border-gray-700 shadow-sm cursor-pointer active:scale-95 transition-transform" onclick="triggerHaptic(); openAvatarModal()">
                    <img id="userAvatarImg" src="" class="hidden w-full h-full object-cover">
                    <span id="userAvatarPlaceholder">üë§</span>
                </div>
                <div><h1 id="userNameDisplay" class="font-bold text-lg leading-tight cursor-default">...</h1></div>
            </div>
            <div class="flex items-center gap-4">
                <div id="toggleEditWrapper" class="hidden">
                    <input type="checkbox" id="menuToggle" class="toggle-checkbox" onchange="toggleEditMode()">
                    <label for="menuToggle" class="toggle-label"></label>
                </div>
                <button onclick="logout()" class="text-blue-500 text-sm font-medium active:opacity-60">–í–∏–π—Ç–∏</button>
            </div>
        </nav>

        <div class="container mx-auto p-4 max-w-lg space-y-4">
            <div class="flex justify-between items-center ios-card p-1.5 glass-panel">
                <div class="flex bg-[#E5E5EA] dark:bg-[#2C2C2E] rounded-[12px] p-1 w-full">
                    <button onclick="setMode('list')" id="btnModeList" class="flex-1 py-2 text-xs font-bold rounded-[10px] bg-white dark:bg-[#636366] shadow-sm text-black dark:text-white transition-all">–°–ø–∏—Å–æ–∫</button>
                    <button onclick="setMode('calendar')" id="btnModeCalendar" class="flex-1 py-2 text-xs font-medium text-gray-500 transition-all">–ö–∞–ª–µ–Ω–¥–∞—Ä</button>
                </div>
                <div class="flex items-center gap-4 ml-4 pr-2">
                    <button onclick="toggleTheme()" class="text-gray-400 text-xl active:scale-90 transition-transform"><span id="themeIcon">üåô</span></button>
                </div>
            </div>

            <button onclick="openFilterModal()" class="ios-card w-full px-4 py-4 flex justify-between items-center active:scale-[0.98] transition-transform glass-panel">
                <span class="text-sm font-semibold text-gray-500">–§—ñ–ª—å—Ç—Ä –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</span>
                <div class="flex items-center gap-2"><span id="currentFilterLabel" class="text-blue-500 font-bold text-sm">–í—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</span><span class="text-gray-300 text-xs">‚ñº</span></div>
            </button>

            <div id="adminPanel" class="hidden ios-card p-5 border border-orange-100 dark:border-orange-900/30 animate-slide-up">
                <h2 class="text-xl font-bold mb-4">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h2>
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">
                    <button onclick="showAdminTab('shifts')" class="bg-[#F2F2F7] dark:bg-[#2C2C2E] px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">–ì—Ä–∞—Ñ—ñ–∫</button>
                    <button onclick="showAdminTab('tasks')" class="bg-[#F2F2F7] dark:bg-[#2C2C2E] px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">–ó–∞–¥–∞—á—ñ</button>
                    <button onclick="showAdminTab('import')" class="bg-indigo-100 text-indigo-600 px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">–Ü–º–ø–æ—Ä—Ç</button>
                    <button onclick="showAdminTab('news')" class="bg-pink-100 text-pink-600 px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">–ù–æ–≤–∏–Ω–∏</button>
                    <button onclick="showAdminTab('requests')" class="hidden bg-red-100 text-red-600 px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap" id="tabRequestsBtn">–ó–∞–ø–∏—Ç–∏</button>
                    <button onclick="showAdminTab('logs')" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">–õ–æ–≥–∏</button>
                </div>
                
                <div id="adminTabShifts" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3"><input type="date" id="shiftDate" class="ios-input"><select id="employeeSelect" class="ios-input bg-transparent"><option disabled selected>–•—Ç–æ?</option></select></div>
                    <div class="flex items-center justify-between"><span class="text-sm font-medium">üå¥ –í—ñ–¥–ø—É—Å—Ç–∫–∞</span><input type="checkbox" id="shiftVacation" onchange="toggleShiftTimeInputs()" class="w-6 h-6 accent-teal-500 rounded-lg"></div>
                    <div id="shiftTimeInputs" class="flex gap-3"><input type="time" id="startTime" class="ios-input" value="10:00"><input type="time" id="endTime" class="ios-input" value="20:00"></div>
                    <button onclick="addShift()" class="btn-primary">–î–æ–¥–∞—Ç–∏ –∑–º—ñ–Ω—É</button>
                    <div class="flex gap-2 mt-2">
                        <button onclick="clearDay()" class="text-xs text-red-500 border border-red-200 dark:border-red-900 w-1/2 py-2 rounded-lg font-medium active:scale-95 transition-transform">–û—á–∏—Å—Ç–∏—Ç–∏ –¥–µ–Ω—å</button>
                        <button onclick="clearMonth()" class="text-xs text-white bg-red-500 w-1/2 py-2 rounded-lg font-bold shadow-md shadow-red-500/30 active:scale-95 transition-transform">üóë –û—á–∏—Å—Ç–∏—Ç–∏ –º—ñ—Å—è—Ü—å</button>
                    </div>
                </div>
                
                <div id="adminTabTasks" class="hidden space-y-3"><input type="text" id="taskTitle" placeholder="–ù–∞–∑–≤–∞" class="ios-input"><div class="grid grid-cols-2 gap-3"><input type="date" id="taskDate" class="ios-input"><select id="taskEmployee" class="ios-input bg-transparent"><option disabled selected>–ö–æ–º—É?</option></select></div><div class="flex items-center justify-between"><span class="text-sm">–í–µ—Å—å –¥–µ–Ω—å</span><input type="checkbox" id="taskFullDay" onchange="toggleTaskTimeInputs()" class="w-5 h-5 accent-purple-500"></div><div id="taskTimeInputs" class="flex gap-3"><input type="time" id="taskStart" class="ios-input" value="12:00"><input type="time" id="taskEnd" class="ios-input" value="14:00"></div><button onclick="addTask()" class="btn-primary bg-purple-500">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏</button></div>
                <div id="adminTabImport" class="hidden space-y-3"><textarea id="importData" placeholder="2026-01-01 –Ü–º'—è 10:00 20:00" class="ios-input h-24 font-mono text-xs"></textarea><button onclick="bulkImport()" class="btn-primary bg-indigo-500">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button></div>
                
                <div id="adminTabNews" class="hidden space-y-3">
                    <div class="flex gap-2 mb-1 overflow-x-auto pb-1">
                        <button onclick="formatText('bold')" class="bg-gray-200 dark:bg-[#3A3A3C] px-3 py-1 rounded-lg text-xs font-bold">B</button>
                        <button onclick="formatText('italic')" class="bg-gray-200 dark:bg-[#3A3A3C] px-3 py-1 rounded-lg text-xs italic">I</button>
                        <button onclick="formatText('link')" class="bg-gray-200 dark:bg-[#3A3A3C] px-3 py-1 rounded-lg text-xs">üîó</button>
                    </div>
                    <textarea id="newsText" placeholder="–ù–æ–≤–∏–Ω–∞..." class="ios-input h-32 text-sm"></textarea>
                    
                    <label class="flex-1 flex items-center justify-center gap-2 bg-[#E5E5EA] dark:bg-[#2C2C2E] p-3 rounded-xl cursor-pointer hover:opacity-80 transition-opacity mt-2">
                        <span class="text-xl">üìé</span> 
                        <span id="fileName" class="text-xs truncate">–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª–∏ (–º–æ–∂–Ω–∞ –¥–µ–∫—ñ–ª—å–∫–∞)</span>
                        <input type="file" id="newsFile" class="hidden" multiple onchange="updateFileName()">
                    </label>
                    
                    <button onclick="publishNews()" class="btn-primary bg-pink-500 mt-2">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
                </div>
                
                <div id="adminTabRequests" class="hidden space-y-3"><button onclick="approveAllRequests()" class="btn-primary bg-green-500">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –í—Å—ñ</button><div id="requestsList" class="space-y-3"></div></div>
                <div id="adminTabLogs" class="hidden space-y-2"><button onclick="loadLogs()" class="btn-primary bg-gray-500 text-xs py-2 mb-2">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –ª–æ–≥–∏</button><div id="logsList" class="text-xs space-y-2 max-h-60 overflow-y-auto pr-2"></div></div>
            </div>

            <div id="listViewContainer">
                <button id="archiveToggleBtn" onclick="toggleArchive()" class="hidden w-full text-center text-xs text-gray-400 py-3 mb-2 font-medium active:scale-95 transition-transform">‚Üì –ú–∏–Ω—É–ª—ñ –¥–Ω—ñ (<span id="archiveCount">0</span>) ‚Üì</button>
                <div id="archiveContainer" class="hidden space-y-3 mb-3 opacity-60 grayscale"></div>
                <div id="scheduleView" class="space-y-4 pb-10"></div>
            </div>

            <div id="calendarViewContainer" class="hidden ios-card p-4 animate-slide-up">
                <div class="flex justify-between items-center mb-4"><button onclick="changeMonth(-1)" class="text-blue-500 text-2xl font-bold p-2">‚Äπ</button><h2 id="calendarTitle" class="font-bold text-xl capitalize"></h2><button onclick="changeMonth(1)" class="text-blue-500 text-2xl font-bold p-2">‚Ä∫</button></div>
                <div class="grid grid-cols-7 gap-1 text-center text-[10px] text-gray-400 uppercase mb-2 font-bold"><div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div class="text-red-400">–ù–¥</div></div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>
        </div>

        <div id="filterModal" class="hidden fixed inset-0 z-50"><div class="absolute inset-0 bg-black/30 backdrop-blur-sm transition-opacity" onclick="closeFilterModal()"></div><div class="absolute bottom-0 left-0 right-0 glass-modal rounded-t-[24px] max-h-[70vh] overflow-y-auto p-4 animate-slide-up shadow-2xl"><div class="flex justify-between items-center mb-4 px-2"><h3 class="font-bold text-lg">–§—ñ–ª—å—Ç—Ä</h3><button onclick="closeFilterModal()" class="w-8 h-8 bg-gray-100 dark:bg-[#2C2C2E] rounded-full text-gray-500 text-sm font-bold">‚úï</button></div><div id="filterList" class="space-y-2"></div></div></div>
        <div id="avatarModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"><div class="absolute inset-0 bg-black/60 backdrop-blur-md" onclick="closeAvatarModal()"></div><div class="glass-modal rounded-2xl w-full max-w-sm p-6 relative z-10 text-center animate-slide-up"><h3 class="font-bold text-xl mb-4">–í–∞—à–µ —Ñ–æ—Ç–æ</h3><div class="avatar-preview-container mb-6 shadow-xl"><img id="avatarPreview" class="avatar-preview-img hidden"><div id="avatarPlaceholder" class="w-full h-full flex items-center justify-center text-4xl text-gray-400">üì∑</div></div><label class="btn-primary block mb-3 cursor-pointer shadow-lg shadow-blue-500/30">–û–±—Ä–∞—Ç–∏ –Ω–æ–≤–µ —Ñ–æ—Ç–æ<input type="file" id="avatarInput" accept="image/*" class="hidden" onchange="handleAvatarSelect(this)"></label><div id="avatarActions" class="hidden space-y-2"><button onclick="uploadAvatar()" class="btn-primary bg-green-500 shadow-green-500/30">–ó–±–µ—Ä–µ–≥—Ç–∏</button><button onclick="closeAvatarModal()" class="w-full py-3 text-red-500 font-medium">–°–∫–∞—Å—É–≤–∞—Ç–∏</button></div></div></div>
        <div id="notesModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"><div class="absolute inset-0 bg-black/60 backdrop-blur-md" onclick="closeNotesModal()"></div><div class="glass-modal rounded-2xl w-full max-w-sm p-5 relative z-10 animate-slide-up"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg" id="notesModalTitle">–ù–æ—Ç–∞—Ç–∫–∏</h3><button onclick="closeNotesModal()" class="text-gray-400 text-2xl">√ó</button></div><div id="notesList" class="space-y-2 mb-4 max-h-48 overflow-y-auto"></div><div class="border-t border-gray-100 dark:border-gray-800 pt-4"><textarea id="newNoteText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —â–æ—Å—å..." class="ios-input h-20 text-sm mb-3"></textarea><div class="flex gap-2"><div id="noteTypeToggle" class="hidden items-center gap-2 bg-[#E5E5EA] dark:bg-[#2C2C2E] px-3 rounded-lg cursor-pointer active:scale-95 transition-transform" onclick="toggleNoteType()"><span id="noteTypeIcon">üîí</span> <span class="text-xs font-bold" id="noteTypeLabel">–û—Å–æ–±–∏—Å—Ç–∞</span></div><button onclick="saveNote()" class="btn-primary flex-1">–î–æ–¥–∞—Ç–∏</button></div></div></div></div>

    </div>

    <script>
        const tg = window.Telegram.WebApp;
        if(tg) { tg.ready(); if(tg.platform && tg.platform!=='unknown') try{tg.expand()}catch(e){} }
        function triggerHaptic() { if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }

        let currentUser = null; let globalShifts = []; let globalUsers = []; let globalTasks = []; let globalNotes = [];
        let activeFilter = 'all'; const START_HOUR = 10; const TOTAL_HOURS = 10; let currentCalendarDate = new Date();
        let selectedNoteDate = null; let currentNoteType = 'private';

        function initTheme() { if ((tg?.colorScheme === 'dark') || localStorage.theme === 'dark') { document.documentElement.classList.add('dark'); document.getElementById('themeIcon').innerText = '‚òÄÔ∏è'; if(tg?.setHeaderColor){tg.setHeaderColor('#1C1C1E'); tg.setBackgroundColor('#000000');} } else { document.documentElement.classList.remove('dark'); document.getElementById('themeIcon').innerText = 'üåô'; if(tg?.setHeaderColor){tg.setHeaderColor('#FFFFFF'); tg.setBackgroundColor('#F2F2F7');} } }
        function toggleTheme() { triggerHaptic(); const html = document.documentElement; if (html.classList.contains('dark')) { html.classList.remove('dark'); localStorage.theme = 'light'; document.getElementById('themeIcon').innerText = 'üåô'; if(tg?.setHeaderColor){tg.setHeaderColor('#FFFFFF'); tg.setBackgroundColor('#F2F2F7');} } else { html.classList.add('dark'); localStorage.theme = 'dark'; document.getElementById('themeIcon').innerText = '‚òÄÔ∏è'; if(tg?.setHeaderColor){tg.setHeaderColor('#1C1C1E'); tg.setBackgroundColor('#000000');} } }
        initTheme();

        async function checkAuth() { 
            try { const res = await fetch('/api/me'); const data = await res.json(); if (data.loggedIn) { showApp(data.user); return; } } catch (e) {}
            if (!tg.initDataUnsafe?.user?.id) { document.getElementById('skeletonLoader').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); return; }
            try { const res = await fetch('/api/login-telegram', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telegramId: tg.initDataUnsafe.user.id }) }); const data = await res.json(); if (data.success) showApp(data.user); else { document.getElementById('skeletonLoader').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); } } catch (e) { document.getElementById('skeletonLoader').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); }
        }
        async function login() { triggerHaptic(); const u = document.getElementById('loginUser').value; const p = document.getElementById('loginPass').value; try { const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username:u, password:p }) }); const data = await res.json(); if (data.success) showApp(data.user); else alert(data.message); } catch (e) { alert("Error"); } }
        async function logout() { triggerHaptic(); await fetch('/api/logout', { method: 'POST' }); window.location.reload(); }

        async function showApp(user) {
            currentUser = user;
            document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('skeletonLoader').classList.add('hidden');
            const app = document.getElementById('appScreen'); app.classList.remove('hidden'); setTimeout(() => app.classList.remove('opacity-0'), 50);
            const parts = user.name.split(' '); document.getElementById('userNameDisplay').innerText = `–ü—Ä–∏–≤—ñ—Ç, ${parts.length > 1 ? parts[1] : parts[0]}`; 
            if(user.avatar) { document.getElementById('userAvatarImg').src = user.avatar; document.getElementById('userAvatarImg').classList.remove('hidden'); document.getElementById('userAvatarPlaceholder').classList.add('hidden'); }
            if (['admin', 'SM', 'SSE', 'RRP'].includes(user.role)) { if(user.role !== 'RRP') document.getElementById('toggleEditWrapper').classList.remove('hidden'); if (['SM', 'admin'].includes(user.role)) { document.getElementById('tabRequestsBtn').classList.remove('hidden'); loadRequests(); } if (user.role === 'SM' || user.role === 'admin') { document.getElementById('noteTypeToggle').classList.remove('hidden'); document.getElementById('noteTypeToggle').classList.add('flex'); } }
            await Promise.all([loadEmployeeList(), loadShifts(), loadTasks(), loadNotes()]); renderCurrentShifts();
        }

        function renderTimeline(shifts, filterUser) {
            const main = document.getElementById('scheduleView'); main.innerHTML = '';
            const archive = document.getElementById('archiveContainer'); archive.innerHTML = '';
            const dates = [...new Set([...shifts.map(s => s.date), ...globalNotes.map(n => n.date)])].sort();
            const today = new Date().toISOString().split('T')[0]; if (!dates.includes(today)) dates.push(today); dates.sort();
            let pastDaysCount = 0;
            let usersToShow = (activeFilter === 'all') ? globalUsers : globalUsers.filter(u => u.name === activeFilter);

            // Calc monthly hours for each user in view
            const currentMonthPrefix = today.substring(0, 7);
            const userHours = {};
            usersToShow.forEach(u => {
                let h = 0;
                shifts.filter(s => s.name === u.name && s.date.startsWith(currentMonthPrefix) && s.start !== '–í—ñ–¥–ø—É—Å—Ç–∫–∞').forEach(s => {
                    const [h1, m1] = s.start.split(':').map(Number);
                    const [h2, m2] = s.end.split(':').map(Number);
                    h += (h2 + m2/60) - (h1 + m1/60);
                });
                userHours[u.name] = h.toFixed(0);
            });

            dates.forEach((dateStr, index) => {
                const isPast = dateStr < today; const isToday = dateStr === today;
                const dObj = new Date(dateStr); const dName = dObj.toLocaleDateString('uk-UA', { weekday: 'long', day: 'numeric', month: 'long' });
                const animClass = isPast ? '' : `animate-slide-up stagger-${(index % 5) + 1}`;
                const block = document.createElement('div');
                block.className = `ios-card p-4 ${animClass}`;
                if(isToday) block.classList.add('ring-2', 'ring-blue-500', 'shadow-lg', 'shadow-blue-500/20');

                let html = `<div class="mb-3 border-b border-gray-100 dark:border-gray-800 pb-2 flex justify-between items-center cursor-pointer active:opacity-60" onclick="triggerHaptic(); openNotesModal('${dateStr}')"><h3 class="font-bold text-lg capitalize ${isToday?'text-blue-500':'text-black dark:text-white'}">${dName}</h3><div class="text-blue-500 text-xs font-bold px-2 py-1 bg-blue-50 dark:bg-blue-900/30 rounded-lg">üìù –ù–æ—Ç–∞—Ç–∫–∏</div></div>`;
                const dayNotes = globalNotes.filter(n => n.date === dateStr);
                if (dayNotes.length > 0) { html += `<div class="mb-3 space-y-1.5">`; dayNotes.forEach(n => { const style = n.type === 'public' ? 'bg-blue-50 text-blue-800 dark:bg-blue-900/40 dark:text-blue-200 border-l-2 border-blue-500' : 'bg-yellow-50 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-200 border-l-2 border-yellow-500'; const icon = n.type === 'public' ? 'üì¢' : 'üîí'; html += `<div class="text-[11px] p-2 rounded-r-md ${style} flex items-start gap-1"><span>${icon}</span> <span><b>${n.author}:</b> ${n.text}</span></div>`; }); html += `</div>`; }
                html += `<div class="space-y-4">`;

                usersToShow.forEach(user => {
                    const shift = shifts.find(s => s.date === dateStr && s.name === user.name);
                    const userTasks = globalTasks.filter(t => t.date === dateStr && t.name === user.name);
                    const parts = user.name.split(' '); const shortName = parts.length > 1 ? parts[1] : parts[0];
                    const hoursBadges = ` <span class="text-[9px] text-gray-400 font-normal">(${userHours[user.name]} –≥–æ–¥.)</span>`;
                    
                    // Avatar HTML
                    let avatarHtml = `<div class="w-5 h-5 rounded-full bg-gray-200 flex items-center justify-center text-[10px] overflow-hidden mr-2 border border-gray-300 dark:border-gray-600">üë§</div>`;
                    if(user.avatar) avatarHtml = `<div class="w-5 h-5 rounded-full overflow-hidden mr-2 border border-gray-300 dark:border-gray-600"><img src="${user.avatar}" class="w-full h-full object-cover"></div>`;

                    if (shift) {
                        const isMe = shift.name === currentUser.name;
                        const delShift = (['admin','SM','SSE'].includes(currentUser.role) && currentUser.role !== 'RRP') ? `<button onclick="delS('${shift.date}','${shift.name}')" class="ml-auto text-gray-300 hover:text-red-500 p-1">‚úï</button>` : '';

                        if (shift.start === '–í—ñ–¥–ø—É—Å—Ç–∫–∞') {
                            html += `<div><div class="flex items-center text-xs mb-1 font-medium ${isMe?'text-teal-600 font-bold':'text-gray-900 dark:text-gray-200'}">${avatarHtml} <span>${shortName}</span> ${hoursBadges} <span class="ml-2 text-teal-500 font-mono">–í—ñ–¥–ø—É—Å—Ç–∫–∞</span> ${delShift}</div><div class="timeline-track"><div class="shift-segment vacation-segment">–í–Ü–î–ü–£–°–¢–ö–ê üå¥</div></div></div>`;
                        } else {
                            const [sH, sM] = shift.start.split(':').map(Number); const [eH, eM] = shift.end.split(':').map(Number); 
                            const startDecimal = sH + sM/60; const endDecimal = eH + eM/60;   
                            let left = ((startDecimal - START_HOUR) / TOTAL_HOURS) * 100; let width = ((endDecimal - startDecimal) / TOTAL_HOURS) * 100; if(left < 0) { width += left; left = 0; } if(left + width > 100) width = 100 - left;
                            
                            let tasksHtml = ''; let badges = '';
                            userTasks.forEach(task => { 
                                if(task.isFullDay) {
                                    badges += `<span class="ml-2 text-[10px] text-purple-600 font-bold border border-purple-200 bg-purple-50 px-1 rounded">‚òÖ ${task.title}</span>`; 
                                } else { 
                                    const [tS_h, tS_m] = task.start.split(':').map(Number); const [tE_h, tE_m] = task.end.split(':').map(Number); 
                                    const tStartD = tS_h + tS_m/60; const tEndD = tE_h + tE_m/60; 
                                    let tLeft = ((tStartD - START_HOUR) / TOTAL_HOURS) * 100; let tWidth = ((tEndD - tStartD) / TOTAL_HOURS) * 100; 
                                    const canDelTask = (['admin','SM','SSE'].includes(currentUser.role) && currentUser.role !== 'RRP');
                                    const delAction = canDelTask ? `onclick="deleteTask('${task._id}'); event.stopPropagation();"` : '';
                                    tasksHtml += `<div class="task-segment" style="left:${tLeft}%; width:${tWidth}%;" ${delAction}>${task.title}</div>`; 
                                } 
                            });
                            
                            html += `<div><div class="flex items-center text-xs mb-1 font-medium ${isMe?'text-blue-600 font-bold':'text-gray-900 dark:text-gray-200'}">${avatarHtml} <span>${shortName}</span> ${hoursBadges} <span class="ml-2 text-gray-400 font-mono">${shift.start}-${shift.end}</span> ${badges} ${delShift}</div><div class="timeline-track shadow-inner"><div class="timeline-grid-overlay">${Array(10).fill('<div class="timeline-line"></div>').join('')}</div><div class="shift-segment ${isMe?'my-shift':''}" style="left:${left}%; width:${width}%"></div>${tasksHtml}</div></div>`;
                        }
                    } else if (userTasks.length > 0) { 
                        let tasksHtml = ''; userTasks.forEach(task => { if(!task.isFullDay) { const [tS_h, tS_m] = task.start.split(':').map(Number); const [tE_h, tE_m] = task.end.split(':').map(Number); const tStartD = tS_h + tS_m/60; const tEndD = tE_h + tE_m/60; let tLeft = ((tStartD - START_HOUR) / TOTAL_HOURS) * 100; let tWidth = ((tEndD - tStartD) / TOTAL_HOURS) * 100; const canDelTask = (['admin','SM','SSE'].includes(currentUser.role) && currentUser.role !== 'RRP'); const delAction = canDelTask ? `onclick="deleteTask('${task._id}'); event.stopPropagation();"` : ''; tasksHtml += `<div class="task-segment" style="left:${tLeft}%; width:${tWidth}%;" ${delAction}>${task.title}</div>`; } });
                        html += `<div class="opacity-80"><div class="flex items-center text-xs mb-1 text-gray-500">${avatarHtml} <span>${shortName}</span> ${hoursBadges} <span class="ml-2 text-orange-500 font-bold">–¢—ñ–ª—å–∫–∏ –∑–∞–¥–∞—á–∞</span></div><div class="timeline-track"><div class="timeline-grid-overlay">${Array(10).fill('<div class="timeline-line"></div>').join('')}</div>${tasksHtml}</div></div>`; 
                    } else { html += `<div class="opacity-40"><div class="flex items-center justify-between text-xs mb-1 text-gray-400"><div>${avatarHtml} <span>${shortName}</span> ${hoursBadges}</div> <span>–í–∏—Ö—ñ–¥–Ω–∏–π</span></div><div class="h-[1px] bg-gray-200 dark:bg-gray-800 rounded w-full mt-3 mb-4"></div></div>`; }
                });
                html += `</div>`; block.innerHTML = html; if(isPast) { archive.appendChild(block); pastDaysCount++; } else { main.appendChild(block); } if(isToday) setTimeout(()=>block.scrollIntoView({behavior:'smooth',block:'center'}),600);
            });
            const arcBtn = document.getElementById('archiveToggleBtn'); const arcCnt = document.getElementById('archiveCount');
            if(pastDaysCount > 0) { arcBtn.classList.remove('hidden'); arcCnt.innerText = pastDaysCount; } else { arcBtn.classList.add('hidden'); }
        }

        document.querySelectorAll('button').forEach(b => b.addEventListener('click', () => triggerHaptic()));

        // Utils
        async function loadEmployeeList() { const r=await fetch('/api/users'); if(r.ok){const d=await r.json(); globalUsers=d.filter(u=>u.role!=='admin'&&u.role!=='RRP'); const s1=document.getElementById('employeeSelect'); const s2=document.getElementById('taskEmployee'); s1.innerHTML='<option disabled selected>–•—Ç–æ?</option>'; s2.innerHTML='<option disabled selected>–ö–æ–º—É?</option>'; globalUsers.forEach(x=>{s1.innerHTML+=`<option value="${x.name}">${x.name}</option>`; s2.innerHTML+=`<option value="${x.name}">${x.name}</option>`;}); } }
        async function loadShifts() { const r = await fetch('/api/shifts'); if(r.ok) globalShifts = await r.json(); }
        async function loadTasks() { const r = await fetch('/api/tasks'); if(r.ok) globalTasks = await r.json(); }
        async function loadNotes() { const r = await fetch('/api/notes'); if(r.ok) globalNotes = await r.json(); }
        async function loadRequests(){ const r=await fetch('/api/requests'); const d=await r.json(); const c=document.getElementById('requestsList'); c.innerHTML=''; if(!d.length){c.innerHTML='<p class="text-gray-400 text-xs text-center">–ü—É—Å—Ç–æ</p>';return;} d.forEach(q=>{c.innerHTML+=`<div class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-xs flex justify-between"><span>${q.type}: ${q.createdBy}</span><div class="flex gap-2"><button onclick="handleRequest('${q._id}','approve')" class="text-green-600">‚úÖ</button><button onclick="handleRequest('${q._id}','reject')" class="text-red-600">‚ùå</button></div></div>`}); }
        async function loadLogs() { const r = await fetch('/api/logs'); const logs = await r.json(); const c = document.getElementById('logsList'); c.innerHTML = ''; logs.forEach(l => { const date = new Date(l.timestamp).toLocaleString('uk-UA'); c.innerHTML += `<div class="bg-gray-50 dark:bg-gray-800 p-2 rounded border-l-2 border-gray-400"><div class="font-bold text-[10px] text-gray-400">${date}</div><div><b>${l.performer}</b>: ${l.action} (${l.details})</div></div>`; }); }

        function setMode(m){ triggerHaptic(); document.getElementById('listViewContainer').className = m === 'list' ? '' : 'hidden'; document.getElementById('calendarViewContainer').className = m === 'list' ? 'hidden' : 'ios-card p-4 animate-slide-up'; const btnList = document.getElementById('btnModeList'); const btnCal = document.getElementById('btnModeCalendar'); if (m === 'list') { btnList.className = "flex-1 py-2 text-xs font-bold rounded-[10px] bg-white dark:bg-[#636366] shadow-sm text-black dark:text-white transition-all"; btnCal.className = "flex-1 py-2 text-xs font-medium text-gray-500 transition-all"; } else { btnList.className = "flex-1 py-2 text-xs font-medium text-gray-500 transition-all"; btnCal.className = "flex-1 py-2 text-xs font-bold rounded-[10px] bg-white dark:bg-[#636366] shadow-sm text-black dark:text-white transition-all"; } if(m === 'calendar') renderCalendar(); }
        function toggleEditMode(){ triggerHaptic(); document.getElementById('adminPanel').classList.toggle('hidden'); }
        function toggleTaskTimeInputs(){ const c=document.getElementById('taskFullDay').checked;document.getElementById('taskTimeInputs').className=c?'hidden':'flex gap-3'; }
        function toggleShiftTimeInputs(){ const c=document.getElementById('shiftVacation').checked;document.getElementById('shiftTimeInputs').className=c?'hidden':'flex gap-3'; }
        function showAdminTab(t){ triggerHaptic(); ['shifts','tasks','requests','import','news','logs'].forEach(x=>document.getElementById('adminTab'+x.charAt(0).toUpperCase()+x.slice(1)).classList.add('hidden'));document.getElementById('adminTab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('hidden');if(t==='requests')loadRequests(); if(t==='logs')loadLogs(); }
        
        function openFilterModal() { triggerHaptic(); document.getElementById('filterModal').classList.remove('hidden'); renderFilterList(); }
        function renderFilterList() { let html = `<button onclick="applyFilter('all')" class="w-full text-left p-3 rounded-xl flex justify-between items-center ${activeFilter==='all' ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-500 font-bold' : 'hover:bg-gray-50 dark:hover:bg-[#2C2C2E]'}"><span class="font-medium">–í—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</span>${activeFilter==='all' ? '<span>‚úì</span>' : ''}</button>`; globalUsers.forEach(u => { const isSelected = activeFilter === u.name; html += `<button onclick="applyFilter('${u.name}')" class="w-full text-left p-3 rounded-xl flex justify-between items-center ${isSelected ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-500 font-bold' : 'hover:bg-gray-50 dark:hover:bg-[#2C2C2E]'}"><span class="font-medium">${u.name}</span>${isSelected ? '<span>‚úì</span>' : ''}</button>`; }); document.getElementById('filterList').innerHTML = html; }
        function closeFilterModal() { document.getElementById('filterModal').classList.add('hidden'); }
        function applyFilter(val) { triggerHaptic(); activeFilter = val; document.getElementById('currentFilterLabel').innerText = val === 'all' ? '–í—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏' : val.split(' ')[1] || val; closeFilterModal(); renderCurrentShifts(); }

        async function clearMonth() {
            const d = document.getElementById('shiftDate').value;
            if(!d) return alert("–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É –≤ –ø–æ—Ç—Ä—ñ–±–Ω–æ–º—É –º—ñ—Å—è—Ü—ñ");
            const month = d.substring(0, 7); 
            if(confirm(`‚ö†Ô∏è –í–ò–î–ê–õ–ò–¢–ò –í–ï–°–¨ –ì–†–ê–§–Ü–ö –∑–∞ ${month}? –¶–µ –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–æ.`)) {
                await fetch('/api/shifts/clear-month', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ month })
                });
                loadShifts().then(renderCurrentShifts);
                alert("–ú—ñ—Å—è—Ü—å –æ—á–∏—â–µ–Ω–æ");
            }
        }

        async function addShift() { const date=document.getElementById('shiftDate').value; const name=document.getElementById('employeeSelect').value; const isVacation = document.getElementById('shiftVacation').checked; let start, end; if (isVacation) { start = '–í—ñ–¥–ø—É—Å—Ç–∫–∞'; end = '–í—ñ–¥–ø—É—Å—Ç–∫–∞'; } else { start=document.getElementById('startTime').value; end=document.getElementById('endTime').value; } if(!date||!name)return alert("–î–∞–Ω—ñ?"); const r=await fetch('/api/shifts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date,name,start,end})}); const d=await r.json(); if(d.pending)alert("–ù–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—ñ"); loadShifts().then(renderCurrentShifts); }
        async function addTask() { const title=document.getElementById('taskTitle').value; const date=document.getElementById('taskDate').value; const name=document.getElementById('taskEmployee').value; const isFullDay=document.getElementById('taskFullDay').checked; const start=document.getElementById('taskStart').value; const end=document.getElementById('taskEnd').value; if(!title||!date||!name)return alert("–î–∞–Ω—ñ?"); await fetch('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title,date,name,isFullDay,start,end})}); loadTasks().then(renderCurrentShifts); }
        
        async function publishNews() { 
            const text = document.getElementById('newsText').value; 
            const files = document.getElementById('newsFile').files; 
            if (!text && files.length === 0) return alert("–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –∞–±–æ –æ–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª–∏"); 
            const formData = new FormData(); formData.append('text', text); 
            for (let i = 0; i < files.length; i++) { formData.append('media', files[i]); }
            const btn = document.querySelector('#adminTabNews button:last-child'); 
            btn.innerText = "‚è≥ –ü—É–±–ª—ñ–∫—É—é..."; btn.disabled = true; 
            try { 
                const res = await fetch('/api/news/publish', { method: 'POST', body: formData }); 
                if (res.ok) { alert("‚úÖ –û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!"); document.getElementById('newsText').value = ''; document.getElementById('newsFile').value = ''; updateFileName(); } else { alert("–ü–æ–º–∏–ª–∫–∞"); } 
            } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞"); } finally { btn.innerText = "–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏"; btn.disabled = false; } 
        }

        async function bulkImport() { 
            const raw = document.getElementById('importData').value; 
            if(!raw) return alert("–ü—É—Å—Ç–æ"); 
            const rows = raw.trim().split('\n'); 
            const shifts = []; 
            rows.forEach(row => { 
                const parts = row.trim().split(/[\t, ]+/); 
                if (parts.length < 3) return; 
                const date = parts[0];
                const lastEl = parts[parts.length - 1].toLowerCase();
                if(lastEl.includes('–≤—ñ–¥–ø—É—Å—Ç–∫–∞') || lastEl.includes('vacation')) {
                    const name = parts.slice(1, parts.length - 1).join(' ');
                    shifts.push({ date, name, start: '–í—ñ–¥–ø—É—Å—Ç–∫–∞', end: '–í—ñ–¥–ø—É—Å—Ç–∫–∞' }); 
                } 
                else if(parts.length >= 4) { 
                    const start = parts[parts.length - 2];
                    const end = parts[parts.length - 1];
                    const name = parts.slice(1, parts.length - 2).join(' ');
                    shifts.push({ date, name, start, end }); 
                } 
            }); 
            if(shifts.length === 0) return alert("–ù–µ —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ"); 
            if(confirm(`–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ ${shifts.length} –∑–º—ñ–Ω?`)) { 
                const res = await fetch('/api/shifts/bulk', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ shifts }) }); 
                if(res.ok) { document.getElementById('importData').value = ''; loadShifts().then(renderCurrentShifts); alert("–£—Å–ø—ñ—à–Ω–æ!"); } else { alert("–ü–æ–º–∏–ª–∫–∞"); } 
            } 
        }

        async function delS(d,n){if(confirm("?")) await fetch('/api/delete-shift',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date:d,name:n})});loadShifts().then(renderCurrentShifts);}
        async function deleteTask(id){ if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–¥–∞—á—É?")) { await fetch('/api/tasks/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}); loadTasks().then(renderCurrentShifts); } }
        function clearDay(){const d=document.getElementById('shiftDate').value; if(d&&confirm(`Clean ${d}?`))fetch('/api/shifts/clear-day',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date:d})}).then(()=>{loadShifts().then(renderCurrentShifts)});}
        function toggleArchive(){ triggerHaptic(); document.getElementById('archiveContainer').classList.toggle('hidden'); }
        function renderCurrentShifts(){renderTimeline(globalShifts,null);renderCalendar();}
        function changeMonth(d){triggerHaptic(); currentCalendarDate.setMonth(currentCalendarDate.getMonth()+d);renderCalendar();}
        function formatText(type) { const field = document.getElementById('newsText'); const start = field.selectionStart; const end = field.selectionEnd; const text = field.value; const selectedText = text.substring(start, end); let before = '', after = ''; if (type === 'bold') { before = '<b>'; after = '</b>'; } else if (type === 'italic') { before = '<i>'; after = '</i>'; } else if (type === 'link') { const url = prompt("URL:", "https://"); if (!url) return; before = `<a href="${url}">`; after = '</a>'; } const content = selectedText || (type === 'link' ? '–ø–æ—Å–∏–ª–∞–Ω–Ω—è' : '—Ç–µ–∫—Å—Ç'); field.value = text.substring(0, start) + before + content + after + text.substring(end); field.focus(); }
        
        function updateFileName() { 
            const input = document.getElementById('newsFile'); 
            const count = input.files.length;
            const label = document.getElementById('fileName');
            if (count > 0) { label.innerText = count === 1 ? input.files[0].name : `–û–±—Ä–∞–Ω–æ ${count} —Ñ–∞–π–ª—ñ–≤`; } else { label.innerText = "–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª–∏ (–º–æ–∂–Ω–∞ –¥–µ–∫—ñ–ª—å–∫–∞)"; }
        }

        function renderCalendar() { 
            const g = document.getElementById('calendarGrid'); 
            g.innerHTML=''; 
            const t = document.getElementById('calendarTitle'); 
            const y = currentCalendarDate.getFullYear(); 
            const m = currentCalendarDate.getMonth(); 
            t.innerText = new Date(y, m).toLocaleDateString('uk-UA', { month: 'long', year: 'numeric' }); 
            const fd = new Date(y, m, 1).getDay() || 7; 
            const ld = new Date(y, m + 1, 0).getDate(); 
            const today = new Date().toISOString().split('T')[0];

            for(let i = 1; i < fd; i++) { g.innerHTML += `<div class="calendar-day opacity-0 pointer-events-none"></div>`; }

            for(let d = 1; d <= ld; d++){ 
                const ds = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`; 
                const shift = globalShifts.find(s => s.date === ds && s.name === currentUser.name); 
                const tasks = globalTasks.filter(t => t.date === ds && t.name === currentUser.name); 
                let dayClass = '';
                let content = `<span class="font-bold mb-1">${d}</span>`; 
                if (shift) { 
                    if (shift.start === '–í—ñ–¥–ø—É—Å—Ç–∫–∞') { dayClass = 'vacation-day'; content += `<div class="work-badge">üå¥</div>`; } 
                    else { dayClass = 'my-work-day'; content += `<div class="work-badge">${shift.start}-${shift.end}</div>`; } 
                } 
                if(tasks.length > 0) { content += `<div class="absolute top-1 right-1 w-1.5 h-1.5 bg-purple-500 rounded-full"></div>`; }
                if (ds === today) dayClass += ' today'; 
                g.innerHTML += `<div class="calendar-day ${dayClass}" onclick="triggerHaptic(); openNotesModal('${ds}')">${content}</div>`; 
            } 
        }
        
        function openAvatarModal() { triggerHaptic(); document.getElementById('avatarModal').classList.remove('hidden'); }
        function closeAvatarModal() { document.getElementById('avatarModal').classList.add('hidden'); }
        function handleAvatarSelect(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { const img = document.getElementById('avatarPreview'); img.src = e.target.result; img.classList.remove('hidden'); document.getElementById('avatarPlaceholder').classList.add('hidden'); document.getElementById('avatarActions').classList.remove('hidden'); }; reader.readAsDataURL(input.files[0]); } }
        function uploadAvatar() { const imgElement = document.getElementById('avatarPreview'); const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const size = 200; canvas.width = size; canvas.height = size; const img = new Image(); img.onload = function() { const minSide = Math.min(img.width, img.height); const sx = (img.width - minSide) / 2; const sy = (img.height - minSide) / 2; ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, size, size); const dataUrl = canvas.toDataURL('image/jpeg', 0.7); fetch('/api/user/avatar', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ avatar: dataUrl }) }).then(res => res.json()).then(data => { if(data.success) { document.getElementById('userAvatarImg').src = dataUrl; document.getElementById('userAvatarImg').classList.remove('hidden'); document.getElementById('userAvatarPlaceholder').classList.add('hidden'); closeAvatarModal(); } else { alert('Error'); } }); }; img.src = imgElement.src; }
        
        function openNotesModal(dateStr) { triggerHaptic(); selectedNoteDate = dateStr; document.getElementById('notesModalTitle').innerText = `–ù–æ—Ç–∞—Ç–∫–∏ (${dateStr})`; document.getElementById('notesModal').classList.remove('hidden'); renderNotesList(); }
        function closeNotesModal() { document.getElementById('notesModal').classList.add('hidden'); }
        function renderNotesList() { const list = document.getElementById('notesList'); list.innerHTML = ''; const dayNotes = globalNotes.filter(n => n.date === selectedNoteDate); if (dayNotes.length === 0) list.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">–ù–µ–º–∞—î –Ω–æ—Ç–∞—Ç–æ–∫</p>'; dayNotes.forEach(n => { const isPublic = n.type === 'public'; const style = isPublic ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200' : 'bg-yellow-50 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200'; const icon = isPublic ? 'üì¢' : 'üîí'; const canDelete = (n.author === currentUser.name) || ((currentUser.role === 'SM' || currentUser.role === 'admin') && isPublic); const deleteBtn = canDelete ? `<button onclick="deleteNote('${n._id}')" class="text-red-500 ml-2 font-bold px-2">√ó</button>` : ''; list.innerHTML += `<div class="note-item ${style} p-2 rounded-lg flex justify-between items-center mb-1"><div class="flex-1 text-xs"><span class="mr-1">${icon}</span> <span class="font-bold mr-1">${n.author}:</span> ${n.text}</div>${deleteBtn}</div>`; }); }
        function toggleNoteType() { triggerHaptic(); if (currentNoteType === 'private') { currentNoteType = 'public'; document.getElementById('noteTypeIcon').innerText = 'üì¢'; document.getElementById('noteTypeLabel').innerText = '–í—Å—ñ–º'; } else { currentNoteType = 'private'; document.getElementById('noteTypeIcon').innerText = 'üîí'; document.getElementById('noteTypeLabel').innerText = '–û—Å–æ–±–∏—Å—Ç–∞'; } }
        async function saveNote() { const text = document.getElementById('newNoteText').value; if(!text) return; await fetch('/api/notes', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ date: selectedNoteDate, text, type: currentNoteType }) }); document.getElementById('newNoteText').value = ''; await loadNotes(); renderNotesList(); renderCurrentShifts(); }
        async function deleteNote(id) { if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) return; await fetch('/api/notes/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ id }) }); await loadNotes(); renderNotesList(); renderCurrentShifts(); }

        checkAuth();
    </script>
</body>
</html>