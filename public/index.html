<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shifter</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        ios: {
                            bg: '#F2F2F7',
                            card: '#FFFFFF',
                            blue: '#007AFF',
                            green: '#34C759',
                            red: '#FF3B30',
                            gray: '#8E8E93',
                            input: '#E5E5EA'
                        },
                        darkios: {
                            bg: '#000000',
                            card: '#1C1C1E',
                            input: '#2C2C2E'
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* Apple-like smoothness */
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        /* Glassmorphism Header */
        .glass-header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .dark .glass-header {
            background: rgba(28, 28, 30, 0.8);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* Timeline & Bars */
        .timeline-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; background-color: transparent; border-radius: 8px; overflow: hidden; position: relative; height: 12px; margin-bottom: 8px; }
        .timeline-mark { border-right: 1px solid rgba(0,0,0,0.05); height: 100%; }
        .dark .timeline-mark { border-right-color: rgba(255,255,255,0.05); }
        .timeline-mark:last-child { border-right: none; }
        
        .shift-bar { position: absolute; top: 0; bottom: 0; border-radius: 100px; opacity: 1; z-index: 10; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .task-bar { position: absolute; top: 2px; bottom: 2px; border-radius: 100px; z-index: 20; background-color: #BF5AF2; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); }
        
        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .calendar-day { min-height: 85px; border-radius: 16px; padding: 6px; font-size: 13px; background: white; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.03); transition: transform 0.1s; border: 1px solid transparent; }
        .dark .calendar-day { background: #1C1C1E; color: white; }
        .calendar-day:active { transform: scale(0.98); }
        .calendar-day.empty { background: transparent; box-shadow: none; }
        .calendar-day.today { border: 2px solid #007AFF; }
        
        /* Badges */
        .work-badge { background-color: #007AFF15; color: #007AFF; padding: 3px 6px; border-radius: 6px; margin-top: 2px; text-align: center; font-size: 11px; font-weight: 600; }
        .dark .work-badge { background-color: #0A84FF20; color: #0A84FF; }
        .event-badge { background-color: #FFD60A20; color: #B49104; padding: 2px 5px; border-radius: 4px; font-size: 10px; margin-bottom: 2px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dark .event-badge { background-color: #FFD60A20; color: #FFD60A; }
        .task-badge-full { color: #BF5AF2; font-size: 10px; font-weight: 700; }
        
        /* Custom Inputs (Apple Style) */
        .ios-input { background: #E5E5EA; border: none; border-radius: 12px; padding: 10px 14px; width: 100%; font-size: 15px; outline: none; transition: background 0.2s; }
        .ios-input:focus { background: #D1D1D6; }
        .dark .ios-input { background: #2C2C2E; color: white; }
        .dark .ios-input:focus { background: #3A3A3C; }

        .btn-primary { background: #007AFF; color: white; border-radius: 12px; font-weight: 600; padding: 10px; transition: opacity 0.2s; }
        .btn-primary:active { opacity: 0.7; }
        
        /* Hide scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="bg-[#F2F2F7] text-black dark:bg-black dark:text-white font-sans min-h-screen flex flex-col">

    <div id="loginScreen" class="flex-grow flex items-center justify-center p-6">
        <div class="bg-white dark:bg-[#1C1C1E] p-8 rounded-[24px] shadow-xl w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-blue-500 rounded-[18px] mx-auto mb-6 flex items-center justify-center text-3xl shadow-lg shadow-blue-500/30">üìÖ</div>
            <h1 class="text-3xl font-bold mb-2 tracking-tight">Shifter</h1>
            <p class="text-gray-400 mb-8 text-sm">–£–≤—ñ–π–¥—ñ—Ç—å –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –≥—Ä–∞—Ñ—ñ–∫—É</p>
            
            <div id="tgLoader" class="hidden mb-4 text-blue-500 font-medium animate-pulse">
                üîÑ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ Telegram...
            </div>

            <div id="loginForm" class="space-y-3">
                <input type="text" id="loginUser" placeholder="–õ–æ–≥—ñ–Ω" class="ios-input">
                <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å" class="ios-input">
                <button onclick="login()" class="btn-primary w-full mt-4">–£–≤—ñ–π—Ç–∏</button>
                <p id="loginError" class="text-red-500 text-center mt-4 text-sm hidden"></p>
            </div>
        </div>
    </div>

    <div id="appScreen" class="hidden w-full pb-24">
        
        <nav class="glass-header px-4 py-3 sticky top-0 z-50 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gray-100 dark:bg-[#2C2C2E] rounded-full flex items-center justify-center text-lg">üë§</div>
                <div>
                    <h1 id="userNameDisplay" class="font-bold text-lg leading-tight tracking-tight">...</h1>
                    <div id="hoursDisplay" class="text-sm text-gray-500 font-medium hidden">0 –≥–æ–¥.</div>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button id="toggleEditBtn" onclick="toggleEditMode()" class="hidden bg-gray-200 dark:bg-[#3A3A3C] text-black dark:text-white px-3 py-1.5 rounded-full text-xs font-bold transition">–†–µ–¥.</button>
                <button onclick="logout()" class="text-blue-500 text-sm font-medium">–í–∏–π—Ç–∏</button>
            </div>
        </nav>

        <div class="container mx-auto p-4 max-w-lg space-y-4">
            
            <div class="flex justify-between items-center bg-white dark:bg-[#1C1C1E] p-1.5 rounded-[14px] shadow-sm">
                <div class="flex bg-[#E5E5EA] dark:bg-[#2C2C2E] rounded-[10px] p-0.5 w-full">
                    <button onclick="setMode('list')" id="btnModeList" class="flex-1 py-1.5 text-xs font-semibold rounded-[8px] transition-all bg-white dark:bg-[#636366] shadow-sm">–°–ø–∏—Å–æ–∫</button>
                    <button onclick="setMode('calendar')" id="btnModeCalendar" class="flex-1 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 rounded-[8px] transition-all">–ö–∞–ª–µ–Ω–¥–∞—Ä</button>
                </div>
                <div class="flex items-center gap-2 ml-3 pr-1">
                    <button onclick="downloadAllMyShifts()" class="text-blue-500 text-xl">üì•</button>
                    <button onclick="toggleTheme()" class="text-gray-400 text-xl"><span id="themeIcon">üåô</span></button>
                </div>
            </div>

            <div id="filterContainer" class="bg-white dark:bg-[#1C1C1E] px-4 py-3 rounded-[18px] shadow-sm flex items-center justify-between">
                <span class="text-sm font-semibold text-gray-500">–§—ñ–ª—å—Ç—Ä</span>
                <select id="viewFilter" onchange="renderCurrentShifts()" class="bg-transparent text-blue-500 font-medium text-sm outline-none text-right w-2/3">
                    <option value="all">–í—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</option>
                </select>
            </div>

            <div id="adminPanel" class="hidden bg-white dark:bg-[#1C1C1E] p-5 rounded-[24px] shadow-lg border border-orange-100 dark:border-orange-900/30">
                <h2 class="text-xl font-bold text-black dark:text-white mb-4 tracking-tight">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h2>
                
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">
                    <button onclick="showAdminTab('shifts')" class="bg-[#F2F2F7] dark:bg-[#2C2C2E] text-black dark:text-white px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">–ì—Ä–∞—Ñ—ñ–∫</button>
                    <button onclick="showAdminTab('tasks')" class="bg-[#F2F2F7] dark:bg-[#2C2C2E] text-black dark:text-white px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">–ó–∞–¥–∞—á—ñ</button>
                    <button onclick="showAdminTab('events')" class="bg-[#F2F2F7] dark:bg-[#2C2C2E] text-black dark:text-white px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">–ü–æ–¥—ñ—ó</button>
                    <button id="tabRequestsBtn" onclick="showAdminTab('requests')" class="hidden bg-red-100 text-red-600 px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap">–ó–∞–ø–∏—Ç–∏</button>
                </div>

                <div id="adminTabShifts" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="date" id="shiftDate" class="ios-input">
                        <select id="employeeSelect" class="ios-input bg-transparent"><option value="" disabled selected>–•—Ç–æ?</option></select>
                    </div>
                    <div class="flex gap-3 items-center">
                        <input type="time" id="startTime" class="ios-input text-center" value="10:00">
                        <span class="text-gray-300">to</span>
                        <input type="time" id="endTime" class="ios-input text-center" value="20:00">
                    </div>
                    <button onclick="addShift()" class="btn-primary w-full bg-orange-500 hover:bg-orange-600">–î–æ–¥–∞—Ç–∏ –∑–º—ñ–Ω—É</button>
                    
                    <div id="adminOnlyFunctions" class="hidden pt-4 border-t border-gray-100 dark:border-gray-800">
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="clearDay()" class="text-xs text-red-500 bg-red-50 dark:bg-red-900/20 py-3 rounded-xl font-medium">–û—á–∏—Å—Ç–∏—Ç–∏ –¥–µ–Ω—å</button>
                            <button onclick="clearMonth()" class="text-xs text-red-500 bg-red-50 dark:bg-red-900/20 py-3 rounded-xl font-medium">–û—á–∏—Å—Ç–∏—Ç–∏ –º—ñ—Å—è—Ü—å</button>
                        </div>
                    </div>
                </div>

                <div id="adminTabTasks" class="hidden space-y-3">
                    <input type="text" id="taskTitle" placeholder="–ù–∞–∑–≤–∞ –∑–∞–¥–∞—á—ñ" class="ios-input">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="date" id="taskDate" class="ios-input">
                        <select id="taskEmployee" class="ios-input bg-transparent"><option value="" disabled selected>–ö–æ–º—É?</option></select>
                    </div>
                    <div class="flex items-center justify-between bg-[#F2F2F7] dark:bg-[#2C2C2E] p-3 rounded-xl">
                        <span class="text-sm font-medium">–í–µ—Å—å –¥–µ–Ω—å</span>
                        <input type="checkbox" id="taskFullDay" onchange="toggleTaskTimeInputs()" class="w-5 h-5 accent-purple-500">
                    </div>
                    <div id="taskTimeInputs" class="flex gap-3 items-center">
                        <input type="time" id="taskStart" class="ios-input text-center" value="12:00">
                        <span class="text-gray-300">to</span>
                        <input type="time" id="taskEnd" class="ios-input text-center" value="14:00">
                    </div>
                    <button onclick="addTask()" class="btn-primary w-full bg-purple-500 hover:bg-purple-600">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏</button>
                </div>

                <div id="adminTabEvents" class="hidden space-y-3">
                    <input type="text" id="eventTitle" placeholder="–ü–æ–¥—ñ—è" class="ios-input">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="date" id="eventDate" class="ios-input">
                        <select id="eventRepeat" class="ios-input bg-transparent"><option value="none">–ë–µ–∑ –ø–æ–≤—Ç–æ—Ä—É</option><option value="weekly">–©–æ—Ç–∏–∂–Ω—è</option><option value="monthly">–©–æ–º—ñ—Å—è—Ü—è</option><option value="yearly">–©–æ—Ä–æ–∫—É</option></select>
                    </div>
                    <button onclick="addEvent()" class="btn-primary w-full bg-yellow-500 hover:bg-yellow-600 text-black">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                    <div id="eventListAdmin" class="mt-4 space-y-2"></div>
                </div>

                <div id="adminTabRequests" class="hidden space-y-3">
                    <button onclick="approveAllRequests()" class="btn-primary w-full bg-green-500 hover:bg-green-600">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –í—Å—ñ</button>
                    <div id="requestsList" class="space-y-3"></div>
                </div>
            </div>

            <div id="listViewContainer">
                <button id="archiveToggleBtn" onclick="toggleArchive()" class="hidden w-full text-center text-xs text-gray-400 py-3 hover:text-gray-600 transition">–ü–æ–∫–∞–∑–∞—Ç–∏ –º–∏–Ω—É–ª—ñ (<span id="archiveCount">0</span>)</button>
                <div id="archiveContainer" class="hidden space-y-3 mb-3 opacity-60 grayscale"></div>
                <div id="scheduleView" class="space-y-3"></div>
            </div>

            <div id="calendarViewContainer" class="hidden bg-white dark:bg-[#1C1C1E] p-4 rounded-[24px] shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="changeMonth(-1)" class="text-blue-500 text-xl font-bold px-2">‚Äπ</button>
                    <h2 id="calendarTitle" class="font-bold text-xl capitalize tracking-tight"></h2>
                    <button onclick="changeMonth(1)" class="text-blue-500 text-xl font-bold px-2">‚Ä∫</button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-[11px] font-semibold text-gray-400 uppercase mb-2">
                    <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div class="text-red-400">–ù–¥</div>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>

        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        let currentUser = null; let globalShifts = []; let globalUsers = []; let globalEvents = []; let globalTasks = [];
        const START_HOUR = 10; const END_HOUR = 20; const TOTAL_HOURS = END_HOUR - START_HOUR;
        let currentCalendarDate = new Date();

        // THEME LOGIC
        function initTheme() {
            if (tg.colorScheme === 'dark' || localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { 
                document.documentElement.classList.add('dark'); document.getElementById('themeIcon').innerText = '‚òÄÔ∏è'; tg.setHeaderColor('#1C1C1E'); tg.setBackgroundColor('#000000');
            } else { 
                document.documentElement.classList.remove('dark'); document.getElementById('themeIcon').innerText = 'üåô'; tg.setHeaderColor('#FFFFFF'); tg.setBackgroundColor('#F2F2F7');
            }
        }
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) { html.classList.remove('dark'); localStorage.theme = 'light'; document.getElementById('themeIcon').innerText = 'üåô'; tg.setHeaderColor('#FFFFFF'); tg.setBackgroundColor('#F2F2F7'); } 
            else { html.classList.add('dark'); localStorage.theme = 'dark'; document.getElementById('themeIcon').innerText = '‚òÄÔ∏è'; tg.setHeaderColor('#1C1C1E'); tg.setBackgroundColor('#000000'); }
        }
        initTheme();

        // AUTH
        async function checkAuth() { 
            try { const res = await fetch('/api/me'); const data = await res.json(); if (data.loggedIn) { showApp(data.user); return; } } catch (e) {}
            const tgUserId = tg.initDataUnsafe?.user?.id;
            if (tgUserId) {
                document.getElementById('loginForm').classList.add('hidden'); document.getElementById('tgLoader').classList.remove('hidden');
                try {
                    const res = await fetch('/api/login-telegram', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telegramId: tgUserId }) });
                    const data = await res.json();
                    if (data.success) showApp(data.user); 
                    else { document.getElementById('tgLoader').classList.add('hidden'); document.getElementById('loginForm').classList.remove('hidden'); }
                } catch (e) { document.getElementById('tgLoader').classList.add('hidden'); document.getElementById('loginForm').classList.remove('hidden'); }
            } else { showLogin(); }
        }
        async function login() { const username = document.getElementById('loginUser').value; const password = document.getElementById('loginPass').value; try { const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) }); const data = await res.json(); if (data.success) showApp(data.user); else { document.getElementById('loginError').innerText = data.message; document.getElementById('loginError').classList.remove('hidden'); } } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞"); } }
        async function logout() { await fetch('/api/logout', { method: 'POST' }); window.location.reload(); }
        function showLogin() { currentUser = null; document.getElementById('appScreen').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); }

        function showApp(user) {
            currentUser = user; document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('appScreen').classList.remove('hidden');
            
            // FIX 1: NAME SHORTENING (First word only)
            const shortName = user.name.split(' ')[0]; // –ë–µ—Ä–µ–º–æ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä—à–µ —Å–ª–æ–≤–æ (–¥–æ –ø—Ä–æ–±—ñ–ª—É)
            document.getElementById('userNameDisplay').innerText = `–ü—Ä–∏–≤—ñ—Ç, ${shortName}`; 
            
            document.getElementById('userActionsPanel').classList.remove('hidden');
            if (user.role === 'admin' || user.role === 'SM' || user.role === 'SSE') {
                document.getElementById('toggleEditBtn').classList.remove('hidden');
                if (user.role === 'SM' || user.role === 'admin') { document.getElementById('tabRequestsBtn').classList.remove('hidden'); document.getElementById('adminOnlyFunctions').classList.remove('hidden'); loadRequests(); } 
                else { document.getElementById('tabRequestsBtn').classList.add('hidden'); document.getElementById('adminOnlyFunctions').classList.add('hidden'); }
            } else { document.getElementById('toggleEditBtn').classList.add('hidden'); }
            Promise.all([loadEmployeeList(), loadShifts(), loadEvents(), loadTasks()]).then(() => { calculateHours(); renderCurrentShifts(); if(user.role === 'admin' || user.role === 'SM' || user.role === 'SSE') renderAdminEventList(); });
        }

        // --- RENDER LOGIC (UPDATED DESIGN) ---
        function renderTimeline(shifts, filterUser) {
            const main = document.getElementById('scheduleView'); const archive = document.getElementById('archiveContainer'); const archBtn = document.getElementById('archiveToggleBtn'); const archCount = document.getElementById('archiveCount');
            main.innerHTML = ''; archive.innerHTML = '';
            const dates = [...new Set(shifts.map(s => s.date))].sort(); const today = new Date().toISOString().split('T')[0]; if(!dates.includes(today)) dates.push(today); dates.sort();
            let pastC = 0; let todayId = null;

            dates.forEach(dStr => {
                const isPast = dStr < today; const isToday = dStr === today; const evs = getEventsForDate(dStr);
                const block = document.createElement('div');
                // Apple Card Style
                block.className = 'bg-white dark:bg-[#1C1C1E] rounded-[20px] shadow-sm p-4';
                if(isToday) { block.className += ' ring-2 ring-blue-500'; block.id='todayBlock'; todayId='todayBlock'; }

                const dObj = new Date(dStr); 
                const dName = dObj.toLocaleDateString('uk-UA', { weekday: 'long', day: 'numeric', month: 'long' });
                let evHtml = ''; evs.forEach(e => evHtml+=`<span class="event-badge ml-2">üìå ${e.title}</span>`);

                let html = `<div class="flex justify-between items-center mb-3 border-b border-gray-100 dark:border-gray-800 pb-2">
                                <span class="font-bold text-lg capitalize tracking-tight ${isToday ? 'text-blue-500' : 'text-black dark:text-white'}">
                                    ${dName} ${isToday ? '<span class="bg-blue-500 text-white text-[10px] px-2 py-0.5 rounded-full ml-1 align-middle">–°—å–æ–≥–æ–¥–Ω—ñ</span>':''}
                                </span>
                                <div>${evHtml}</div>
                            </div><div class="space-y-4">`;

                let users = (filterUser==='all') ? globalUsers : globalUsers.filter(u=>u.name===filterUser);
                const dayShifts = shifts.filter(s=>s.date===dStr);
                
                // Sort Logic
                users.sort((a,b) => {
                    const sA = dayShifts.find(s=>s.name===a.name); const sB = dayShifts.find(s=>s.name===b.name);
                    if(sA && !sB) return -1; if(!sA && sB) return 1; return a.name.localeCompare(b.name);
                });

                let hasInfo = false;
                users.forEach(u => {
                    const s = dayShifts.find(x=>x.name===u.name);
                    const ts = globalTasks.filter(t=>t.date===dStr && t.name===u.name);
                    if(s || ts.length>0) hasInfo = true;

                    if(s) {
                        const isMe = s.name === currentUser.name;
                        // Time calc
                        const [sH,sM] = s.start.split(':').map(Number); const [eH,eM] = s.end.split(':').map(Number);
                        let l = ((sH+sM/60 - START_HOUR)/TOTAL_HOURS)*100; let w = ((eH+eM/60 - (sH+sM/60))/TOTAL_HOURS)*100;
                        if(l<0){w+=l;l=0} if(l+w>100)w=100-l;

                        // Tasks Bars
                        let tBars = ''; let tBadges = '';
                        ts.forEach(t => {
                            if(t.isFullDay) {
                                tBadges += `<span class="task-badge-full ml-2">‚òÖ ${t.title}</span>`;
                            } else {
                                const [tS_h, tS_m] = t.start.split(':').map(Number); const [tE_h, tE_m] = t.end.split(':').map(Number);
                                let tl = ((tS_h+tS_m/60 - START_HOUR)/TOTAL_HOURS)*100; let tw = ((tE_h+tE_m/60 - (tS_h+tS_m/60))/TOTAL_HOURS)*100;
                                if(tl<0){tw+=tl;tl=0} if(tl+tw>100)tw=100-tl;
                                const del = (['admin','SM','SSE'].includes(currentUser.role)) ? `onclick="deleteTask('${t._id}')"` : '';
                                tBars += `<div class="task-bar flex items-center justify-center text-[9px] text-white font-bold" ${del} style="left:${tl}%; width:${tw}%;">${t.title}</div>`;
                            }
                        });
                        
                        // Render Row
                        const delS = (['admin','SM','SSE'].includes(currentUser.role)) ? `<button onclick="deleteShiftInGroup('${s.date}','${s.name}')" class="ml-2 text-gray-400 hover:text-red-500 text-xs">‚úï</button>` : '';
                        
                        // Short name for timeline too
                        const shortName = u.name.split(' ')[0];

                        html += `<div>
                            <div class="flex items-center justify-between text-xs mb-1 font-medium ${isMe?'text-blue-500':'text-gray-900 dark:text-gray-200'}">
                                <div class="flex items-center">
                                    <span class="text-sm font-semibold">${shortName}</span>
                                    <span class="text-gray-400 ml-2 font-mono text-[10px]">${s.start}-${s.end}</span>
                                    ${tBadges}
                                </div>
                                ${delS}
                            </div>
                            <div class="timeline-grid">
                                ${Array(10).fill('<div class="timeline-mark"></div>').join('')}
                                <div class="shift-bar ${isMe?'bg-blue-500 shadow-lg shadow-blue-500/40':'bg-green-500'}" style="left:${l}%; width:${w}%"></div>
                                ${tBars}
                            </div>
                        </div>`;
                    } else if (ts.length > 0) {
                        let tBadges = ''; ts.forEach(t=>tBadges+=`<span class="task-badge-full ml-2">‚òÖ ${t.title}</span>`);
                        const shortName = u.name.split(' ')[0];
                        html += `<div class="opacity-70"><div class="flex items-center text-xs mb-1"><span>${shortName}</span> <span class="text-gray-400 ml-2">–í–∏—Ö—ñ–¥–Ω–∏–π</span> ${tBadges}</div><div class="h-1 bg-gray-100 dark:bg-gray-800 rounded-full w-full"></div></div>`;
                    }
                });
                
                html += `</div>`; // Close space-y-4
                block.innerHTML = html;

                if(hasInfo) {
                    if(isPast) { archive.appendChild(block); pastC++; } else main.appendChild(block);
                }
            });

            if(pastC>0) { archBtn.classList.remove('hidden'); archCount.innerText=pastC; } else archBtn.classList.add('hidden');
            if(todayId) setTimeout(()=>document.getElementById(todayId)?.scrollIntoView({behavior:'smooth',block:'center'}),500);
        }

        // --- FIX 2: HOURS TEXT ---
        function calculateHours() {
            if (!currentUser) return;
            const now = new Date(); const cm = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            const ms = globalShifts.filter(s => s.name === currentUser.name && s.date.startsWith(cm));
            let tm = 0;
            ms.forEach(s => {
                const [sh, sm] = s.start.split(':').map(Number); const [eh, em] = s.end.split(':').map(Number);
                tm += ((eh * 60 + em) - (sh * 60 + sm));
            });
            const h = Math.floor(tm / 60); 
            // FIX: Short text
            document.getElementById('hoursDisplay').innerText = `${h} –≥–æ–¥–∏–Ω`; 
            document.getElementById('hoursDisplay').classList.remove('hidden');
        }

        // --- HELPERS (SAME LOGIC, just ensure they are present) ---
        // (Copied strictly from logic, just referencing variables)
        // ... Loaders ...
        async function loadEmployeeList() { const r=await fetch('/api/users'); const d=await r.json(); const w=d.filter(u=>u.role!=='admin'); globalUsers=w; 
            const s1=document.getElementById('employeeSelect'); s1.innerHTML='<option value="" disabled selected>–•—Ç–æ?</option>'; 
            const s2=document.getElementById('taskEmployee'); s2.innerHTML='<option value="" disabled selected>–ö–æ–º—É?</option>';
            const s3=document.getElementById('viewFilter'); s3.innerHTML='<option value="all">–í—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</option>';
            w.forEach(x=>{ 
                const nm = x.name; // Keep full name for value, display could be short if needed, but select needs distinct values
                s1.innerHTML+=`<option value="${nm}">${nm}</option>`; s2.innerHTML+=`<option value="${nm}">${nm}</option>`; s3.innerHTML+=`<option value="${nm}">${nm}</option>`; 
            }); 
        }
        async function loadShifts(){const r=await fetch('/api/shifts');if(r.ok)globalShifts=await r.json();}
        async function loadEvents(){const r=await fetch('/api/events');globalEvents=await r.json();}
        async function loadTasks(){const r=await fetch('/api/tasks');globalTasks=await r.json();}
        async function loadRequests(){const r=await fetch('/api/requests');const d=await r.json();const c=document.getElementById('requestsList');c.innerHTML='';if(d.length===0){c.innerHTML='<p class="text-gray-400 text-xs text-center">–ü—É—Å—Ç–æ</p>';return;} d.forEach(q=>{ let txt=''; if(q.type==='add_shift')txt=`‚ûï –ó–º—ñ–Ω–∞: ${q.data.date} ${q.data.name}`; else if(q.type==='del_shift')txt=`‚ùå –í–∏–¥–∞–ª–µ–Ω–Ω—è: ${q.data.details}`; else txt=q.type; c.innerHTML+=`<div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-xl flex justify-between items-center text-xs"><span class="font-medium">${txt}</span><div class="flex gap-2"><button onclick="handleRequest('${q._id}','approve')" class="text-green-500 font-bold">‚úì</button><button onclick="handleRequest('${q._id}','reject')" class="text-red-500 font-bold">‚úï</button></div></div>`});}
        
        // ... Actions ...
        async function handleRequest(id,a){await fetch('/api/requests/action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,action:a})}); loadRequests(); loadShifts(); loadTasks(); setTimeout(()=>renderCurrentShifts(),500);}
        async function approveAllRequests(){if(confirm('–í—Å—ñ?')){await fetch('/api/requests/approve-all',{method:'POST'});loadRequests();loadShifts();loadTasks();setTimeout(()=>renderCurrentShifts(),500);}}
        
        async function addShift(){const date=document.getElementById('shiftDate').value;const name=document.getElementById('employeeSelect').value;const start=document.getElementById('startTime').value;const end=document.getElementById('endTime').value; if(!date||!name)return alert('–î–∞–Ω—ñ?'); const r=await fetch('/api/shifts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date,name,start,end})}); const d=await r.json(); if(d.pending)alert('–ù–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—ñ'); loadShifts().then(()=>renderCurrentShifts());}
        async function deleteShiftInGroup(d,n){if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')){const r=await fetch('/api/delete-shift',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date:d,name:n})});/*Need proper ID logic from prev code, simplified here*/ const all=globalShifts.find(s=>s.date===d&&s.name===n); if(all){const r2=await fetch('/api/delete-shift',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:all._id})});const d2=await r2.json();if(d2.pending)alert('–ó–∞–ø–∏—Ç –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è');loadShifts().then(()=>renderCurrentShifts());}}}
        
        async function addTask(){const t=document.getElementById('taskTitle').value;const d=document.getElementById('taskDate').value;const n=document.getElementById('taskEmployee').value;const f=document.getElementById('taskFullDay').checked;const s=document.getElementById('taskStart').value;const e=document.getElementById('taskEnd').value; if(!t||!d||!n)return; await fetch('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:t,date:d,name:n,isFullDay:f,start:s,end:e})}); loadTasks().then(()=>renderCurrentShifts());}
        async function deleteTask(id){if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')){const r=await fetch('/api/tasks/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});const d=await r.json();if(d.pending)alert('–ó–∞–ø–∏—Ç');loadTasks().then(()=>renderCurrentShifts());}}
        
        async function addEvent(){const t=document.getElementById('eventTitle').value;const d=document.getElementById('eventDate').value;const r=document.getElementById('eventRepeat').value;if(!t)return;await fetch('/api/events',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:t,date:d,repeat:r})});loadEvents().then(()=>renderCurrentShifts()); renderAdminEventList();}
        function renderAdminEventList(){const l=document.getElementById('eventListAdmin');l.innerHTML='';globalEvents.forEach(e=>{l.innerHTML+=`<div class="flex justify-between border-b border-gray-100 dark:border-gray-800 p-2 text-xs"><span>${e.title} (${e.date})</span><button onclick="deleteEvent('${e._id}')" class="text-red-500">‚úï</button></div>`})}
        async function deleteEvent(id){if(confirm('?'))await fetch('/api/events/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});loadEvents().then(()=>renderCurrentShifts());renderAdminEventList();}
        
        // ... UI Toggles ...
        function toggleEditMode(){const p=document.getElementById('adminPanel');const b=document.getElementById('toggleEditBtn');if(p.classList.contains('hidden')){p.classList.remove('hidden');b.classList.add('bg-blue-500','text-white');b.classList.remove('bg-gray-200','dark:bg-[#3A3A3C]','text-black');}else{p.classList.add('hidden');b.classList.remove('bg-blue-500','text-white');b.classList.add('bg-gray-200','dark:bg-[#3A3A3C]','text-black');}}
        function showAdminTab(t){['shifts','tasks','events','requests'].forEach(x=>document.getElementById('adminTab'+x.charAt(0).toUpperCase()+x.slice(1)).classList.add('hidden'));document.getElementById('adminTab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('hidden');}
        function toggleTaskTimeInputs(){const c=document.getElementById('taskFullDay').checked;const i=document.getElementById('taskTimeInputs');if(c)i.classList.add('opacity-30','pointer-events-none');else i.classList.remove('opacity-30','pointer-events-none');}
        function toggleArchive(){document.getElementById('archiveContainer').classList.toggle('hidden');}
        function renderCurrentShifts(){renderTimeline(globalShifts,document.getElementById('viewFilter').value);renderCalendar();}
        function setMode(m){const l=document.getElementById('listViewContainer');const c=document.getElementById('calendarViewContainer');const f=document.getElementById('filterContainer');const b1=document.getElementById('btnModeList');const b2=document.getElementById('btnModeCalendar'); if(m==='list'){l.classList.remove('hidden');c.classList.add('hidden');f.classList.remove('hidden');b1.className="flex-1 py-1.5 text-xs font-semibold rounded-[8px] transition-all bg-white dark:bg-[#636366] shadow-sm";b2.className="flex-1 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 rounded-[8px] transition-all";}else{l.classList.add('hidden');c.classList.remove('hidden');f.classList.add('hidden');b2.className="flex-1 py-1.5 text-xs font-semibold rounded-[8px] transition-all bg-white dark:bg-[#636366] shadow-sm";b1.className="flex-1 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 rounded-[8px] transition-all";renderCalendar();}}

        function getEventsForDate(d) { const ch = new Date(d); return globalEvents.filter(e => { const ev = new Date(e.date); if(e.repeat==='none')return e.date===d; if(e.repeat==='weekly')return ch>=ev && ch.getDay()===ev.getDay(); if(e.repeat==='monthly')return ch>=ev && ch.getDate()===ev.getDate(); if(e.repeat==='yearly')return ch>=ev && ch.getMonth()===ev.getMonth() && ch.getDate()===ev.getDate(); return false; }); }
        
        function downloadAllMyShifts() { if (!currentUser) return; const today = new Date().toISOString().split('T')[0]; const myShifts = globalShifts.filter(s => s.name === currentUser.name && s.date >= today); if (myShifts.length === 0) return alert("–ù–µ–º–∞—î –∑–º—ñ–Ω!"); let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Shifter//UA\n"; myShifts.forEach(s => { const start = s.date.replace(/-/g, '') + 'T' + s.start.replace(':', '') + '00'; const end = s.date.replace(/-/g, '') + 'T' + s.end.replace(':', '') + '00'; ics += `BEGIN:VEVENT\nDTSTART:${start}\nDTEND:${end}\nSUMMARY:–†–æ–±–æ—Ç–∞\nEND:VEVENT\n`; }); ics += "END:VCALENDAR"; const a = document.createElement('a'); a.href = window.URL.createObjectURL(new Blob([ics], {type: 'text/calendar'})); a.download = `my-shifts.ics`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }

        checkAuth();
    </script>
</body>
</html>