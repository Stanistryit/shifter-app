<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shifter Pro</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script> tailwind.config = { darkMode: 'class' } </script>
    <style>
        /* –°—Ç–∏–ª—ñ –±–µ–∑ –∑–º—ñ–Ω */
        .timeline-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 1px; background-color: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; overflow: hidden; position: relative; height: 16px; margin-bottom: 6px; }
        .dark .timeline-grid { background-color: #374151; border-color: #4b5563; }
        .timeline-mark { border-right: 1px dashed #d1d5db; height: 100%; }
        .dark .timeline-mark { border-right-color: #4b5563; }
        .timeline-mark:last-child { border-right: none; }
        .shift-bar { position: absolute; top: 0; bottom: 0; border-radius: 2px; opacity: 0.9; z-index: 10; transition: all 0.3s; }
        .task-bar { position: absolute; top: 2px; bottom: 2px; border-radius: 2px; opacity: 1; z-index: 20; background-color: #a855f7; box-shadow: 0 0 2px rgba(0,0,0,0.5); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { min-height: 80px; border: 1px solid #e5e7eb; border-radius: 6px; padding: 4px; font-size: 12px; background: white; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; }
        .dark .calendar-day { background: #1f2937; border-color: #374151; color: white; }
        .calendar-day.today { border: 2px solid #3b82f6; }
        .day-label { font-weight: bold; margin-bottom: 2px; display: flex; justify-content: space-between; }
        .work-badge { background-color: #dbeafe; color: #1e40af; padding: 2px 4px; border-radius: 4px; margin-top: 2px; text-align: center; font-size: 10px; }
        .dark .work-badge { background-color: #1e3a8a; color: #93c5fd; }
        .event-badge { background-color: #fef3c7; color: #92400e; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .task-badge-full { background-color: #e9d5ff; color: #6b21a8; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-bottom: 1px; font-weight: bold; border: 1px solid #d8b4fe; }
        .dark .task-badge-full { background-color: #581c87; color: #e9d5ff; border-color: #6b21a8; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 font-sans min-h-screen flex flex-col">

    <div id="loginScreen" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-sm">
            <h1 class="text-2xl font-bold mb-6 text-center text-blue-600 dark:text-blue-400">–í—Ö—ñ–¥ —É Shifter</h1>
            <input type="text" id="loginUser" placeholder="–õ–æ–≥—ñ–Ω" class="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-3 border rounded mb-6 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <button onclick="login()" class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700">–£–≤—ñ–π—Ç–∏</button>
            <p id="loginError" class="text-red-500 text-center mt-4 hidden"></p>
        </div>
    </div>

    <div id="appScreen" class="hidden w-full pb-20">
        <nav class="bg-white dark:bg-gray-800 p-3 border-b dark:border-gray-700 flex justify-between items-center sticky top-0 z-50 shadow-sm">
            <div class="flex items-center gap-2">
                <span class="text-xl">üìÖ</span>
                <div>
                    <h1 class="font-bold leading-tight">Shifter</h1>
                    <div class="flex flex-col text-xs text-gray-500 dark:text-gray-400">
                        <span id="userNameDisplay">...</span>
                        <span id="hoursDisplay" class="text-green-600 dark:text-green-400 font-bold hidden">0 –≥–æ–¥.</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="toggleEditBtn" onclick="toggleEditMode()" class="hidden bg-orange-100 dark:bg-orange-900 text-orange-600 dark:text-orange-300 px-3 py-1 rounded text-xs font-bold border border-orange-200 dark:border-orange-700">üõ† –ú–µ–Ω—é</button>
                <div class="flex bg-gray-100 dark:bg-gray-700 rounded p-1">
                    <button onclick="setMode('list')" id="btnModeList" class="px-3 py-1 text-xs rounded bg-white dark:bg-gray-600 shadow-sm">–°–ø–∏—Å–æ–∫</button>
                    <button onclick="setMode('calendar')" id="btnModeCalendar" class="px-3 py-1 text-xs rounded text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-600">–ö–∞–ª–µ–Ω–¥–∞—Ä</button>
                </div>
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-lg"><span id="themeIcon">üåô</span></button>
                <button onclick="logout()" class="text-xs bg-gray-100 dark:bg-gray-700 px-3 py-2 rounded text-gray-600 dark:text-gray-200">–í–∏–π—Ç–∏</button>
            </div>
        </nav>

        <div class="container mx-auto p-2 max-w-lg">
            
            <div id="userActionsPanel" class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg mb-4 flex justify-between items-center hidden">
                <div class="text-sm"> <span class="font-bold text-blue-800 dark:text-blue-300">üìÖ –ú—ñ–π –∫–∞–ª–µ–Ω–¥–∞—Ä</span> </div>
                <button onclick="downloadAllMyShifts()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-2 rounded shadow flex items-center gap-1">üì• –ï–∫—Å–ø–æ—Ä—Ç</button>
            </div>

            <div id="filterContainer" class="bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm mb-4 flex items-center justify-between">
                <span class="text-sm font-bold text-gray-600 dark:text-gray-400">–§—ñ–ª—å—Ç—Ä:</span>
                <select id="viewFilter" onchange="renderCurrentShifts()" class="text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white border rounded p-1 w-2/3">
                    <option value="all">üë• –í—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</option>
                </select>
            </div>

            <div id="adminPanel" class="hidden bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-6 border-l-4 border-orange-500">
                <h2 class="text-lg font-bold text-orange-600 mb-2">üõ† –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h2>
                
                <div class="flex gap-2 mb-4 text-xs overflow-x-auto">
                    <button onclick="showAdminTab('shifts')" class="bg-orange-100 text-orange-800 px-2 py-1 rounded whitespace-nowrap">–ì—Ä–∞—Ñ—ñ–∫</button>
                    <button onclick="showAdminTab('tasks')" class="bg-purple-100 text-purple-800 px-2 py-1 rounded whitespace-nowrap">–ó–∞–¥–∞—á—ñ</button>
                    <button onclick="showAdminTab('events')" class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded whitespace-nowrap">–ü–æ–¥—ñ—ó</button>
                    <button id="tabRequestsBtn" onclick="showAdminTab('requests')" class="hidden bg-red-100 text-red-800 px-2 py-1 rounded whitespace-nowrap font-bold">üì¨ –ó–∞–ø–∏—Ç–∏</button>
                </div>

                <div id="adminTabShifts">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="date" id="shiftDate" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <select id="employeeSelect" class="p-2 border rounded bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="" disabled selected>–•—Ç–æ?</option></select>
                    </div>
                    <div class="flex gap-2 mb-2 items-center">
                        <input type="time" id="startTime" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="10:00">
                        <span class="text-gray-400">-</span>
                        <input type="time" id="endTime" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="20:00">
                    </div>
                    <button onclick="addShift()" class="w-full bg-orange-500 text-white p-2 rounded font-bold hover:bg-orange-600 mb-2">–î–æ–¥–∞—Ç–∏ –∑–º—ñ–Ω—É</button>
                    
                    <div id="adminOnlyFunctions" class="hidden">
                         <button onclick="toggleImport()" class="text-xs text-blue-500 underline block mb-2">–ú–∞—Å–æ–≤–∏–π —ñ–º–ø–æ—Ä—Ç</button>
                        <div id="bulkImportForm" class="hidden pt-2 border-t dark:border-gray-700">
                            <textarea id="bulkText" rows="3" class="w-full p-2 border rounded text-xs font-mono mb-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
                            <button onclick="uploadBulk()" class="w-full bg-green-600 text-white p-2 rounded font-bold">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-2 pt-2 border-t dark:border-gray-700">
                            <button onclick="clearDay()" class="text-xs text-red-600 border border-red-200 p-1 rounded hover:bg-red-50">–û—á–∏—Å—Ç–∏—Ç–∏ –¥–µ–Ω—å</button>
                            <button onclick="clearMonth()" class="text-xs text-red-600 border border-red-200 p-1 rounded hover:bg-red-50">–û—á–∏—Å—Ç–∏—Ç–∏ –º—ñ—Å—è—Ü—å</button>
                        </div>
                    </div>
                </div>

                <div id="adminTabTasks" class="hidden">
                    <input type="text" id="taskTitle" placeholder="–©–æ —Ä–æ–±–∏—Ç–∏?" class="w-full p-2 border rounded mb-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="date" id="taskDate" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <select id="taskEmployee" class="p-2 border rounded bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="" disabled selected>–ö–æ–º—É?</option></select>
                    </div>
                    <div class="flex items-center gap-2 mb-2">
                        <input type="checkbox" id="taskFullDay" onchange="toggleTaskTimeInputs()" class="w-4 h-4">
                        <label for="taskFullDay" class="text-sm dark:text-gray-300">–í–µ—Å—å –¥–µ–Ω—å</label>
                    </div>
                    <div id="taskTimeInputs" class="flex gap-2 mb-2 items-center">
                        <input type="time" id="taskStart" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="12:00">
                        <span class="text-gray-400">-</span>
                        <input type="time" id="taskEnd" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="14:00">
                    </div>
                    <button onclick="addTask()" class="w-full bg-purple-600 text-white p-2 rounded font-bold hover:bg-purple-700">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –∑–∞–¥–∞—á—É</button>
                </div>

                <div id="adminTabEvents" class="hidden">
                    <input type="text" id="eventTitle" placeholder="–ü–æ–¥—ñ—è" class="w-full p-2 border rounded mb-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="date" id="eventDate" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <select id="eventRepeat" class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="none">–ë–µ–∑ –ø–æ–≤—Ç–æ—Ä—É</option><option value="weekly">–©–æ—Ç–∏–∂–Ω—è</option><option value="monthly">–©–æ–º—ñ—Å—è—Ü—è</option><option value="yearly">–©–æ—Ä–æ–∫—É</option></select>
                    </div>
                    <button onclick="addEvent()" class="w-full bg-yellow-500 text-white p-2 rounded font-bold hover:bg-yellow-600">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                    <div id="eventListAdmin" class="mt-4 space-y-1 text-xs text-gray-600 dark:text-gray-400"></div>
                </div>

                <div id="adminTabRequests" class="hidden">
                    <button onclick="approveAllRequests()" class="w-full bg-green-600 text-white text-xs p-2 rounded font-bold mb-3">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –í—Å—ñ –ó–∞–ø–∏—Ç–∏</button>
                    <div id="requestsList" class="space-y-2">
                        <p class="text-center text-gray-400 text-xs">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
                    </div>
                </div>
            </div>

            <div id="listViewContainer">
                <button id="archiveToggleBtn" onclick="toggleArchive()" class="hidden w-full text-center text-xs text-gray-500 py-2 border-b mb-2 hover:bg-gray-50 dark:hover:bg-gray-800">üìÇ –ú–∏–Ω—É–ª—ñ –¥–Ω—ñ (<span id="archiveCount">0</span>)</button>
                <div id="archiveContainer" class="hidden space-y-4 mb-4 opacity-70 grayscale"></div>
                <div id="scheduleView" class="space-y-4"></div>
            </div>

            <div id="calendarViewContainer" class="hidden">
                <div class="flex justify-between items-center mb-4 bg-white dark:bg-gray-800 p-3 rounded shadow-sm">
                    <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">‚óÄÔ∏è</button>
                    <h2 id="calendarTitle" class="font-bold text-lg capitalize"></h2>
                    <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">‚ñ∂Ô∏è</button>
                </div>
                <div class="grid grid-cols-7 gap-2 text-center text-xs font-bold text-gray-500 mb-2"><div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–ù–¥</div></div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let globalShifts = []; let globalUsers = []; let globalEvents = []; let globalTasks = [];
        const START_HOUR = 10; const END_HOUR = 20; const TOTAL_HOURS = END_HOUR - START_HOUR;
        let currentCalendarDate = new Date();

        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark'); document.getElementById('themeIcon').innerText = '‚òÄÔ∏è'; } 
            else { document.documentElement.classList.remove('dark'); document.getElementById('themeIcon').innerText = 'üåô'; }
        }
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) { html.classList.remove('dark'); localStorage.theme = 'light'; document.getElementById('themeIcon').innerText = 'üåô'; } 
            else { html.classList.add('dark'); localStorage.theme = 'dark'; document.getElementById('themeIcon').innerText = '‚òÄÔ∏è'; }
        }
        initTheme();

        async function checkAuth() { try { const res = await fetch('/api/me'); const data = await res.json(); if (data.loggedIn) showApp(data.user); else showLogin(); } catch (e) { showLogin(); } }
        async function login() {
            const username = document.getElementById('loginUser').value; const password = document.getElementById('loginPass').value;
            try { const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) }); const data = await res.json();
                if (data.success) showApp(data.user); else { document.getElementById('loginError').innerText = data.message; document.getElementById('loginError').classList.remove('hidden'); }
            } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è"); }
        }
        async function logout() { await fetch('/api/logout', { method: 'POST' }); window.location.reload(); }
        function showLogin() { currentUser = null; document.getElementById('appScreen').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); }

        function showApp(user) {
            currentUser = user; document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('userNameDisplay').innerText = user.name; document.getElementById('userActionsPanel').classList.remove('hidden');
            
            // ROLE MANAGEMENT
            if (user.role === 'admin' || user.role === 'SM' || user.role === 'SSE') {
                document.getElementById('toggleEditBtn').classList.remove('hidden');
                
                // –Ø–∫—â–æ —Ü–µ SM –∞–±–æ Admin - –ø–æ–∫–∞–∑—É—î–º–æ –≤–∫–ª–∞–¥–∫—É –∑–∞–ø–∏—Ç—ñ–≤ —ñ –∫–Ω–æ–ø–∫–∏ –º–∞—Å–æ–≤–∏—Ö –¥—ñ–π
                if (user.role === 'SM' || user.role === 'admin') {
                    document.getElementById('tabRequestsBtn').classList.remove('hidden');
                    document.getElementById('adminOnlyFunctions').classList.remove('hidden'); // Bulk import/clear
                    loadRequests(); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–∞–ø–∏—Ç–∏
                } else {
                    // SSE
                    document.getElementById('tabRequestsBtn').classList.add('hidden');
                    document.getElementById('adminOnlyFunctions').classList.add('hidden');
                }
            } else {
                document.getElementById('toggleEditBtn').classList.add('hidden');
            }
            
            Promise.all([loadEmployeeList(), loadShifts(), loadEvents(), loadTasks()]).then(() => {
                calculateHours(); renderCurrentShifts();
                if(user.role === 'admin' || user.role === 'SM' || user.role === 'SSE') renderAdminEventList();
            });
        }

        // ... [–°–¢–ê–ù–î–ê–†–¢–ù–Ü –§–£–ù–ö–¶–Ü–á –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –î–ê–ù–ò–• –¢–£–¢ –¢–ê–ö–Ü –ñ, –Ø–ö –Ü –ë–£–õ–ò] ...
        async function loadEmployeeList() { const res = await fetch('/api/users'); const allUsers = await res.json(); const workers = allUsers.filter(u => u.role !== 'admin'); globalUsers = workers; const adminSelect = document.getElementById('employeeSelect'); adminSelect.innerHTML = '<option value="" disabled selected>–•—Ç–æ?</option>'; const taskSelect = document.getElementById('taskEmployee'); taskSelect.innerHTML = '<option value="" disabled selected>–ö–æ–º—É?</option>'; const filterSelect = document.getElementById('viewFilter'); filterSelect.innerHTML = '<option value="all">üë• –í—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</option>'; workers.forEach(w => { const opt1 = document.createElement('option'); opt1.value = w.name; opt1.innerText = w.name; adminSelect.appendChild(opt1); const optT = document.createElement('option'); optT.value = w.name; optT.innerText = w.name; taskSelect.appendChild(optT); const opt2 = document.createElement('option'); opt2.value = w.name; opt2.innerText = w.name; filterSelect.appendChild(opt2); }); }
        async function loadShifts() { const response = await fetch('/api/shifts'); if (response.status === 403) return; globalShifts = await response.json(); }
        async function loadEvents() { const res = await fetch('/api/events'); globalEvents = await res.json(); }
        async function loadTasks() { const res = await fetch('/api/tasks'); globalTasks = await res.json(); }

        // --- NEW: REQUESTS LOGIC ---
        async function loadRequests() {
            const res = await fetch('/api/requests');
            const requests = await res.json();
            const container = document.getElementById('requestsList');
            container.innerHTML = '';
            
            if (requests.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-xs text-center">–ó–∞–ø–∏—Ç—ñ–≤ –Ω–µ–º–∞—î</p>';
                return;
            }

            requests.forEach(req => {
                let desc = '';
                // –§–æ—Ä–º—É—î–º–æ –æ–ø–∏—Å –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–∏–ø—É
                if(req.type === 'add_shift') desc = `‚ûï –ó–º—ñ–Ω–∞: ${req.data.date}, ${req.data.name} (${req.data.start}-${req.data.end})`;
                else if(req.type === 'del_shift') desc = `‚ùå –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–º—ñ–Ω–∏: ${req.data.details}`;
                else if(req.type === 'add_task') desc = `‚ûï –ó–∞–¥–∞—á–∞: ${req.data.title} –¥–ª—è ${req.data.name}`;
                else if(req.type === 'del_task') desc = `‚ùå –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–¥–∞—á—ñ: ${req.data.details}`;
                else desc = `–Ü–Ω—à–µ: ${req.type}`;

                container.innerHTML += `
                <div class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-xs flex justify-between items-center shadow-sm">
                    <div>
                        <div class="font-bold text-gray-700 dark:text-gray-200">${desc}</div>
                        <div class="text-[10px] text-gray-500">–í—ñ–¥: ${req.createdBy}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="handleRequest('${req._id}', 'approve')" class="text-green-600 font-bold border border-green-200 bg-green-50 px-2 py-1 rounded">‚úÖ</button>
                        <button onclick="handleRequest('${req._id}', 'reject')" class="text-red-600 font-bold border border-red-200 bg-red-50 px-2 py-1 rounded">‚ùå</button>
                    </div>
                </div>`;
            });
        }

        async function handleRequest(id, action) {
            await fetch('/api/requests/action', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, action })
            });
            loadRequests();
            // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ, –±–æ –º–∏ –º–æ–≥–ª–∏ —â–æ—Å—å –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏
            loadShifts(); loadTasks(); loadEvents(); setTimeout(() => renderCurrentShifts(), 500);
        }

        async function approveAllRequests() {
            if(!confirm("–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –í–°–Ü –∑–∞–ø–∏—Ç–∏ —Å–ø–∏—Å–∫–æ–º?")) return;
            await fetch('/api/requests/approve-all', { method: 'POST' });
            loadRequests(); loadShifts(); loadTasks(); setTimeout(() => renderCurrentShifts(), 500);
        }

        // --- UPDATED ADD FUNCTIONS (Handle SSE Pending) ---
        async function addShift() {
            const date = document.getElementById('shiftDate').value; const name = document.getElementById('employeeSelect').value; const start = document.getElementById('startTime').value; const end = document.getElementById('endTime').value; 
            if (!date || !name || !start || !end) return alert("–ó–∞–ø–æ–≤–Ω–∏ –≤—Å–µ!"); 
            const res = await fetch('/api/shifts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date, name, start, end }) });
            const data = await res.json();
            if (data.pending) alert("‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è SM!");
            else alert("‚úÖ –ó–º—ñ–Ω—É –¥–æ–¥–∞–Ω–æ!");
            loadShifts().then(() => renderCurrentShifts());
        }

        async function addTask() {
            const title = document.getElementById('taskTitle').value; const date = document.getElementById('taskDate').value; const name = document.getElementById('taskEmployee').value; const isFullDay = document.getElementById('taskFullDay').checked; const start = document.getElementById('taskStart').value; const end = document.getElementById('taskEnd').value;
            if(!title || !date || !name) return alert("–ó–∞–ø–æ–≤–Ω–∏ –≤—Å–µ!");
            const res = await fetch('/api/tasks', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, date, name, isFullDay, start, end }) });
            const data = await res.json();
            if (data.pending) alert("‚úÖ –ó–∞–¥–∞—á–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è!");
            else alert("‚úÖ –ó–∞–¥–∞—á—É –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ!");
            loadTasks().then(() => renderCurrentShifts());
        }

        async function deleteShiftInGroup(date, name) {
            const res = await fetch('/api/shifts'); const allShifts = await res.json(); const shift = allShifts.find(s => s.date === date && s.name === name);
            if (shift && confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –∑–º—ñ–Ω—É?")) {
                const r = await fetch('/api/delete-shift', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: shift._id }) });
                const d = await r.json();
                if(d.pending) alert("‚ùå –ó–∞–ø–∏—Ç –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ SM.");
                else loadShifts().then(() => renderCurrentShifts());
            }
        }
        
        async function deleteTask(id) {
            if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–¥–∞—á—É?")) return;
            const r = await fetch('/api/tasks/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
            const d = await r.json();
            if(d.pending) alert("‚ùå –ó–∞–ø–∏—Ç –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ SM.");
            else loadTasks().then(() => renderCurrentShifts());
        }

        // --- TABS & UI ---
        function toggleEditMode() {
            const panel = document.getElementById('adminPanel'); const btn = document.getElementById('toggleEditBtn');
            if (panel.classList.contains('hidden')) { panel.classList.remove('hidden'); btn.classList.add('bg-orange-200', 'dark:bg-orange-800'); } 
            else { panel.classList.add('hidden'); btn.classList.remove('bg-orange-200', 'dark:bg-orange-800'); }
        }
        function showAdminTab(tab) {
            document.getElementById('adminTabShifts').classList.add('hidden'); document.getElementById('adminTabEvents').classList.add('hidden'); document.getElementById('adminTabTasks').classList.add('hidden'); document.getElementById('adminTabRequests').classList.add('hidden');
            if(tab === 'shifts') document.getElementById('adminTabShifts').classList.remove('hidden');
            else if(tab === 'events') document.getElementById('adminTabEvents').classList.remove('hidden');
            else if(tab === 'tasks') document.getElementById('adminTabTasks').classList.remove('hidden');
            else if(tab === 'requests') { document.getElementById('adminTabRequests').classList.remove('hidden'); loadRequests(); }
        }

        // --- RENDER FUNCTIONS ---
        function calculateHours() { if (!currentUser) return; const now = new Date(); const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; const myShifts = globalShifts.filter(s => s.name === currentUser.name && s.date.startsWith(currentMonthStr)); let totalMinutes = 0; myShifts.forEach(s => { const [startH, startM] = s.start.split(':').map(Number); const [endH, endM] = s.end.split(':').map(Number); totalMinutes += ((endH * 60 + endM) - (startH * 60 + startM)); }); const hours = Math.floor(totalMinutes / 60); const minutes = totalMinutes % 60; document.getElementById('hoursDisplay').innerText = `${hours} –≥–æ–¥. ${minutes > 0 ? minutes + ' —Ö–≤.' : ''} (—É —Ü—å–æ–º—É –º—ñ—Å—è—Ü—ñ)`; document.getElementById('hoursDisplay').classList.remove('hidden'); }
        function renderCurrentShifts() { renderTimeline(globalShifts, document.getElementById('viewFilter').value); renderCalendar(); }
        function renderTimeline(shifts, filterUser) {
            const mainContainer = document.getElementById('scheduleView'); const archiveContainer = document.getElementById('archiveContainer'); const archiveBtn = document.getElementById('archiveToggleBtn'); const archiveCount = document.getElementById('archiveCount'); mainContainer.innerHTML = ''; archiveContainer.innerHTML = '';
            const uniqueDates = [...new Set(shifts.map(s => s.date))].sort(); const todayStr = new Date().toISOString().split('T')[0]; if (!uniqueDates.includes(todayStr)) uniqueDates.push(todayStr); uniqueDates.sort(); let pastDaysCount = 0; let todayElementId = null;
            uniqueDates.forEach(dateStr => {
                const isPast = dateStr < todayStr; const isToday = dateStr === todayStr; const dayEvents = getEventsForDate(dateStr);
                const dayBlock = document.createElement('div'); dayBlock.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden'; let headerBg = "bg-gray-50 dark:bg-gray-700/50"; if (isToday) { dayBlock.classList.add('ring-2', 'ring-blue-400', 'border-blue-500'); dayBlock.id = "todayBlock"; todayElementId = "todayBlock"; headerBg = "bg-blue-100 dark:bg-blue-900"; }
                const dayDateObj = new Date(dateStr); const dayName = dayDateObj.toLocaleDateString('uk-UA', { weekday: 'short', day: 'numeric', month: 'long' }); let eventsHtml = ''; dayEvents.forEach(ev => { eventsHtml += `<div class="text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded border border-yellow-200 inline-block mr-1">üìå ${ev.title}</div>`; });
                dayBlock.innerHTML = `<div class="${headerBg} px-3 py-2 text-sm flex flex-col border-b dark:border-gray-700"><div class="flex justify-between items-center"><span class="font-bold text-gray-700 dark:text-gray-200 capitalize">${dayName} ${isToday ? '<span class="ml-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full">–°–¨–û–ì–û–î–ù–Ü</span>' : ''}</span></div>${eventsHtml ? `<div class="mt-1">${eventsHtml}</div>` : ''}</div>`;
                const dayContent = document.createElement('div'); dayContent.className = 'p-2 space-y-3'; let usersToShow = (filterUser === 'all') ? globalUsers : globalUsers.filter(u => u.name === filterUser); const shiftsOnThisDay = shifts.filter(s => s.date === dateStr); usersToShow.sort((a, b) => { const aWork = shiftsOnThisDay.find(s => s.name === a.name); const bWork = shiftsOnThisDay.find(s => s.name === b.name); if (aWork && !bWork) return -1; if (!aWork && bWork) return 1; return a.name.localeCompare(b.name); });
                let hasAnyInfo = false;
                usersToShow.forEach(user => {
                    const shift = shiftsOnThisDay.find(s => s.name === user.name); const userTasks = globalTasks.filter(t => t.date === dateStr && t.name === user.name); if (shift || userTasks.length > 0) hasAnyInfo = true;
                    if (shift) {
                        const isMe = shift.name === currentUser.name; const [sH, sM] = shift.start.split(':').map(Number); const [eH, eM] = shift.end.split(':').map(Number); const startH = sH + sM/60; const endH = eH + eM/60; let left = ((startH - START_HOUR) / TOTAL_HOURS) * 100; let width = ((endH - startH) / TOTAL_HOURS) * 100; if (left < 0) { width += left; left = 0; } if (left + width > 100) width = 100 - left; const barColor = isMe ? 'bg-green-500' : 'bg-blue-500'; const nameColor = isMe ? 'text-green-700 dark:text-green-400 font-bold' : 'text-gray-700 dark:text-gray-300 font-bold';
                        let taskBadges = ''; let taskBars = ''; userTasks.forEach(task => { if (task.isFullDay) { taskBadges += `<span class="task-badge-full ml-2" title="${task.title}">‚òÖ ${task.title}</span>`; } else { const [tsH, tsM] = task.start.split(':').map(Number); const [teH, teM] = task.end.split(':').map(Number); const tStartH = tsH + tsM/60; const tEndH = teH + teM/60; let tLeft = ((tStartH - START_HOUR) / TOTAL_HOURS) * 100; let tWidth = ((tEndH - tStartH) / TOTAL_HOURS) * 100; if (tLeft < 0) { tWidth += tLeft; tLeft = 0; } if (tLeft + tWidth > 100) tWidth = 100 - tLeft; const delBtn = (currentUser.role==='admin'||currentUser.role==='SM'||currentUser.role==='SSE') ? `onclick="deleteTask('${task._id}')" style="cursor:pointer;"` : ''; taskBars += `<div class="task-bar flex items-center justify-center text-[8px] text-white font-bold overflow-hidden" ${delBtn} style="left: ${tLeft}%; width: ${tWidth}%;">${task.title}</div>`; } });
                        dayContent.innerHTML += `<div><div class="flex items-center text-xs mb-1 ${nameColor}"><span>${shift.name}</span> <span class="text-gray-500 dark:text-gray-400 ml-1 font-normal">${shift.start}-${shift.end}</span>${taskBadges}</div><div class="timeline-grid">${Array(10).fill('<div class="timeline-mark"></div>').join('')}<div class="shift-bar ${barColor}" style="left: ${left}%; width: ${width}%;"></div>${taskBars}</div><div class="flex justify-end gap-2 h-4">${(currentUser.role==='admin'||currentUser.role==='SM'||currentUser.role==='SSE') ? `<button onclick="deleteShiftInGroup('${shift.date}', '${shift.name}')" class="text-[10px] text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 px-1 rounded">–í–∏–¥–∞–ª–∏—Ç–∏ –∑–º—ñ–Ω—É</button>` : ''}</div></div>`;
                    } else if (userTasks.length > 0) {
                        let taskBadges = ''; userTasks.forEach(task => taskBadges += `<span class="task-badge-full ml-2">‚òÖ ${task.title}</span>`); dayContent.innerHTML += `<div class="opacity-80"><div class="flex items-center text-xs mb-1 text-gray-500 dark:text-gray-400"><span>${user.name}</span> <span class="ml-1">–í–∏—Ö—ñ–¥–Ω–∏–π</span>${taskBadges}</div><div class="h-1 bg-gray-100 dark:bg-gray-700 rounded w-full"></div></div>`;
                    } else { dayContent.innerHTML += `<div class="opacity-60"><div class="flex justify-between text-xs mb-1 text-gray-500 dark:text-gray-400"><span>${user.name}</span><span>–í–∏—Ö—ñ–¥–Ω–∏–π</span></div><div class="h-1 bg-gray-100 dark:bg-gray-700 rounded w-full"></div></div>`; }
                });
                if (hasAnyInfo) { dayBlock.appendChild(dayContent); if (isPast) { archiveContainer.appendChild(dayBlock); pastDaysCount++; } else { mainContainer.appendChild(dayBlock); } }
            });
            if (pastDaysCount > 0) { archiveBtn.classList.remove('hidden'); archiveCount.innerText = pastDaysCount; } else { archiveBtn.classList.add('hidden'); } if (todayElementId) { setTimeout(() => { const el = document.getElementById(todayElementId); if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 500); }
        }

        // ... [HELPERS] ...
        function getEventsForDate(d) { const ch = new Date(d); return globalEvents.filter(e => { const ev = new Date(e.date); if(e.repeat==='none')return e.date===d; if(e.repeat==='weekly')return ch>=ev && ch.getDay()===ev.getDay(); if(e.repeat==='monthly')return ch>=ev && ch.getDate()===ev.getDate(); if(e.repeat==='yearly')return ch>=ev && ch.getMonth()===ev.getMonth() && ch.getDate()===ev.getDate(); return false; }); }
        function renderCalendar() { const g = document.getElementById('calendarGrid'); const t = document.getElementById('calendarTitle'); g.innerHTML = ''; const y = currentCalendarDate.getFullYear(); const m = currentCalendarDate.getMonth(); t.innerText = currentCalendarDate.toLocaleDateString('uk-UA', { month: 'long', year: 'numeric' }); const fd = new Date(y, m, 1); const ld = new Date(y, m + 1, 0); let sdi = fd.getDay() - 1; if (sdi === -1) sdi = 6; for (let i = 0; i < sdi; i++) { const e = document.createElement('div'); e.className = 'calendar-day empty'; g.appendChild(e); } const td = new Date().toISOString().split('T')[0]; for (let d = 1; d <= ld.getDate(); d++) { const ds = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`; const dc = document.createElement('div'); dc.className = 'calendar-day'; if (ds === td) dc.classList.add('today'); const ms = globalShifts.find(s => s.date === ds && s.name === currentUser.name); const de = getEventsForDate(ds); const mt = globalTasks.filter(t => t.date === ds && t.name === currentUser.name); let c = `<div class="day-label"><span>${d}</span></div>`; de.forEach(e => { c += `<div class="event-badge" title="${e.title}">${e.title}</div>`; }); mt.forEach(t => { c += `<div class="text-[9px] text-purple-700 font-bold leading-tight mb-0.5">‚òÖ ${t.title}</div>`; }); if (ms) { dc.classList.add('bg-blue-50', 'dark:bg-blue-900/20'); c += `<div class="work-badge">${ms.start}-${ms.end}</div>`; } else { c += `<div class="text-[10px] text-gray-300 dark:text-gray-600 text-center mt-auto">.</div>`; } dc.innerHTML = c; g.appendChild(dc); } }
        function changeMonth(d) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + d); renderCalendar(); }
        function setMode(m) { const l = document.getElementById('listViewContainer'); const c = document.getElementById('calendarViewContainer'); const f = document.getElementById('filterContainer'); if (m === 'list') { document.getElementById('btnModeList').classList.replace('text-gray-500', 'bg-white'); document.getElementById('btnModeCalendar').classList.replace('bg-white', 'text-gray-500'); l.classList.remove('hidden'); c.classList.add('hidden'); f.classList.remove('hidden'); } else { document.getElementById('btnModeCalendar').classList.replace('text-gray-500', 'bg-white'); document.getElementById('btnModeList').classList.replace('bg-white', 'text-gray-500'); l.classList.add('hidden'); c.classList.remove('hidden'); f.classList.add('hidden'); renderCalendar(); } }
        async function addEvent() { const title = document.getElementById('eventTitle').value; const date = document.getElementById('eventDate').value; const repeat = document.getElementById('eventRepeat').value; if(!title || !date) return alert("–í–∫–∞–∂–∏ –Ω–∞–∑–≤—É —ñ –¥–∞—Ç—É"); await fetch('/api/events', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, date, repeat }) }); alert("–ü–æ–¥—ñ—é —Å—Ç–≤–æ—Ä–µ–Ω–æ!"); loadEvents().then(() => renderCurrentShifts()); }
        function renderAdminEventList() { const list = document.getElementById('eventListAdmin'); list.innerHTML = '<b>–í—Å—ñ –ø–æ–¥—ñ—ó:</b>'; globalEvents.forEach(ev => { const rep = ev.repeat === 'none' ? '' : `(üîÑ ${ev.repeat})`; list.innerHTML += `<div class="flex justify-between border-b border-gray-100 p-1"><span>${ev.date}: ${ev.title} ${rep}</span> <button onclick="deleteEvent('${ev._id}')" class="text-red-500">x</button></div>`; }); }
        async function deleteEvent(id) { if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏?")) return; await fetch('/api/events/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) }); loadEvents().then(() => renderCurrentShifts()); }
        function toggleArchive() { document.getElementById('archiveContainer').classList.toggle('hidden'); }
        async function clearDay() { const date = document.getElementById('shiftDate').value; if (!date) return alert("–û–±–µ—Ä–∏ –¥–∞—Ç—É!"); if (!confirm(`–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –∑–º—ñ–Ω–∏ –∑–∞ ${date}?`)) return; await fetch('/api/shifts/clear-day', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date }) }); loadShifts().then(() => renderCurrentShifts()); }
        async function clearMonth() { const date = document.getElementById('shiftDate').value; if (!date) return alert("–û–±–µ—Ä–∏ –¥–∞—Ç—É!"); const month = date.substring(0, 7); if (!confirm(`–£–í–ê–ì–ê! –í–∏–¥–∞–ª–∏—Ç–∏ –í–ï–°–¨ –≥—Ä–∞—Ñ—ñ–∫ –∑–∞ –º—ñ—Å—è—Ü—å ${month}?`)) return; await fetch('/api/shifts/clear-month', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ month }) }); loadShifts().then(() => renderCurrentShifts()); }
        async function uploadBulk() { const text = document.getElementById('bulkText').value.trim(); if (!text) return; const shifts = []; text.split('\n').forEach(line => { const parts = line.split(','); if (parts.length >= 4) shifts.push({ date: parts[0].trim(), name: parts[1].trim(), start: parts[2].trim(), end: parts[3].trim() }); }); if (shifts.length === 0) return alert("–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç!"); await fetch('/api/shifts/bulk', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ shifts }) }); document.getElementById('bulkText').value = ''; toggleImport(); loadShifts().then(() => renderCurrentShifts()); }
        function toggleImport() { document.getElementById('bulkImportForm').classList.toggle('hidden'); }
        function downloadAllMyShifts() { if (!currentUser) return; const today = new Date().toISOString().split('T')[0]; const myShifts = globalShifts.filter(s => s.name === currentUser.name && s.date >= today); if (myShifts.length === 0) return alert("–ù–µ–º–∞—î –∑–º—ñ–Ω!"); let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Shifter//UA\n"; myShifts.forEach(s => { const start = s.date.replace(/-/g, '') + 'T' + s.start.replace(':', '') + '00'; const end = s.date.replace(/-/g, '') + 'T' + s.end.replace(':', '') + '00'; ics += `BEGIN:VEVENT\nDTSTART:${start}\nDTEND:${end}\nSUMMARY:–†–æ–±–æ—Ç–∞\nEND:VEVENT\n`; }); ics += "END:VCALENDAR"; const a = document.createElement('a'); a.href = window.URL.createObjectURL(new Blob([ics], {type: 'text/calendar'})); a.download = `my-shifts.ics`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        checkAuth();
    </script>
</body>
</html>